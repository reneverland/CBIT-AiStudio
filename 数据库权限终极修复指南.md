# ğŸš¨ CBIT-AiStudio æ•°æ®åº“æƒé™ç»ˆæä¿®å¤æŒ‡å—

## ğŸ“‹ é—®é¢˜ç°è±¡

å¦‚æœä½ æŒç»­é‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š
```
cbit-aistudio | return dialect.connect(*cargs, **cparams)
cbit-aistudio | File "/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 615, in connect
cbit-aistudio | return self.loaded_dbapi.connect(*cargs, **cparams)
cbit-aistudio | sqlite3.OperationalError: unable to open database file
```

è¿™è¡¨æ˜SQLiteæ•°æ®åº“æƒé™é—®é¢˜éå¸¸ä¸¥é‡ï¼Œéœ€è¦ä½¿ç”¨ç»ˆæä¿®å¤æ–¹æ¡ˆã€‚

## ğŸš€ ç»ˆæä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šç´§æ€¥å¼ºåˆ¶ä¿®å¤ï¼ˆæœ¬åœ°/é€šç”¨ç¯å¢ƒï¼‰

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
sudo ./emergency_force_fix.sh
```

**ç‰¹ç‚¹**ï¼š
- ğŸ”¥ æœ€æ¿€è¿›çš„ä¿®å¤æ–¹æ¡ˆ
- ğŸ”„ å®Œå…¨é‡å»ºæ•°æ®ç›®å½•
- ğŸ³ å¼ºåˆ¶é‡å»ºDockeré•œåƒ
- ğŸ’¾ è‡ªåŠ¨å¤‡ä»½ç°æœ‰æ•°æ®
- ğŸ”§ ä½¿ç”¨rootç”¨æˆ·è¿è¡Œå®¹å™¨

### æ–¹æ¡ˆäºŒï¼šå®å¡”ç¯å¢ƒä¸“ç”¨ä¿®å¤

```bash
# åœ¨å®å¡”æœåŠ¡å™¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
sudo ./baota_emergency_fix.sh
```

**ç‰¹ç‚¹**ï¼š
- ğŸ¢ ä¸“é—¨é’ˆå¯¹å®å¡”é¢æ¿ç¯å¢ƒ
- ğŸ”’ ä¸å½±å“å…¶ä»–å®å¡”å®¹å™¨
- ğŸ‘¤ å…¼å®¹å®å¡”wwwç”¨æˆ·æƒé™
- ğŸ› ï¸ åˆ›å»ºå®å¡”ç®¡ç†è„šæœ¬
- ğŸ“Š é›†æˆå®å¡”é¢æ¿åŠŸèƒ½

### æ–¹æ¡ˆä¸‰ï¼šåŸæœ‰ä¿®å¤è„šæœ¬ï¼ˆè½»é‡çº§ï¼‰

```bash
# å¦‚æœé—®é¢˜ä¸ä¸¥é‡ï¼Œå¯ä»¥å…ˆå°è¯•
sudo ./fix_database_permissions.sh
```

## ğŸ” ä¿®å¤æ–¹æ¡ˆé€‰æ‹©æŒ‡å—

### é€‰æ‹©emergency_force_fix.sh å½“ï¼š
- âœ… å¤šæ¬¡ä¿®å¤å¤±è´¥
- âœ… æƒé™é—®é¢˜éå¸¸ä¸¥é‡
- âœ… éœ€è¦å®Œå…¨é‡å»ºç¯å¢ƒ
- âœ… æœ¬åœ°å¼€å‘æˆ–é€šç”¨æœåŠ¡å™¨ç¯å¢ƒ

### é€‰æ‹©baota_emergency_fix.sh å½“ï¼š
- âœ… ä½¿ç”¨å®å¡”é¢æ¿ç®¡ç†æœåŠ¡å™¨
- âœ… æœåŠ¡å™¨ä¸Šæœ‰å…¶ä»–é‡è¦å®¹å™¨
- âœ… éœ€è¦ä¸å®å¡”ç¯å¢ƒå®Œç¾é›†æˆ
- âœ… éœ€è¦å®å¡”ç®¡ç†åŠŸèƒ½

### é€‰æ‹©fix_database_permissions.sh å½“ï¼š
- âœ… é¦–æ¬¡é‡åˆ°æƒé™é—®é¢˜
- âœ… é—®é¢˜ç›¸å¯¹è½»å¾®
- âœ… å¸Œæœ›ä¿æŒç°æœ‰é…ç½®

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

| ä¿®å¤æ–¹æ¡ˆ | ä¿®å¤å¼ºåº¦ | æ•°æ®å®‰å…¨ | ç¯å¢ƒå…¼å®¹ | ç®¡ç†åŠŸèƒ½ |
|---------|---------|---------|---------|---------|
| emergency_force_fix.sh | ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ | ğŸ’¾ğŸ’¾ğŸ’¾ğŸ’¾ | ğŸŒğŸŒğŸŒ | ğŸ› ï¸ğŸ› ï¸ğŸ› ï¸ |
| baota_emergency_fix.sh | ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ | ğŸ’¾ğŸ’¾ğŸ’¾ğŸ’¾ğŸ’¾ | ğŸ¢ğŸ¢ğŸ¢ğŸ¢ğŸ¢ | ğŸ› ï¸ğŸ› ï¸ğŸ› ï¸ğŸ› ï¸ğŸ› ï¸ |
| fix_database_permissions.sh | ğŸ”¥ğŸ”¥ğŸ”¥ | ğŸ’¾ğŸ’¾ğŸ’¾ğŸ’¾ğŸ’¾ | ğŸŒğŸŒğŸŒğŸŒ | ğŸ› ï¸ğŸ› ï¸ |

## ğŸ› ï¸ ä¿®å¤åç®¡ç†

### é€šç”¨ç¯å¢ƒç®¡ç†
```bash
# å¿«é€Ÿé‡å¯
./quick_restart.sh

# æŸ¥çœ‹çŠ¶æ€
docker ps | grep cbit-aistudio

# æŸ¥çœ‹æ—¥å¿—
docker logs cbit-aistudio -f

# å¥åº·æ£€æŸ¥
curl http://localhost:5000/health
```

### å®å¡”ç¯å¢ƒç®¡ç†
```bash
# å¯åŠ¨æœåŠ¡
./baota_manage.sh start

# åœæ­¢æœåŠ¡
./baota_manage.sh stop

# é‡å¯æœåŠ¡
./baota_manage.sh restart

# æŸ¥çœ‹æ—¥å¿—
./baota_manage.sh logs

# æ£€æŸ¥çŠ¶æ€
./baota_manage.sh status

# å¥åº·æ£€æŸ¥
./baota_manage.sh health

# ä¿®å¤æƒé™
./baota_manage.sh fix-permissions
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æƒé™è®¾ç½®è¯¦è§£

**ç›®å½•æƒé™**ï¼š
```bash
# é€šç”¨ç¯å¢ƒ
chmod 777 instance downloads static/uploads

# å®å¡”ç¯å¢ƒ
chown www:www instance downloads static/uploads
chmod 755 instance downloads static/uploads
chmod g+w,o+w instance downloads static/uploads
```

**æ•°æ®åº“æ–‡ä»¶æƒé™**ï¼š
```bash
# é€šç”¨ç¯å¢ƒ
chmod 666 instance/local_cache.db

# å®å¡”ç¯å¢ƒ
chown www:www instance/local_cache.db
chmod 666 instance/local_cache.db
```

### Dockeré…ç½®ä¼˜åŒ–

**å®¹å™¨ç”¨æˆ·è®¾ç½®**ï¼š
```yaml
# å¼ºåˆ¶ä¿®å¤ç‰ˆæœ¬
user: "0:0"  # rootç”¨æˆ·

# å®å¡”ä¼˜åŒ–ç‰ˆæœ¬
user: "0:0"
cap_add:
  - DAC_OVERRIDE
```

**å·æŒ‚è½½ä¼˜åŒ–**ï¼š
```yaml
# ç»‘å®šæŒ‚è½½æ–¹å¼
volumes:
  - type: bind
    source: ./instance
    target: /app/instance
    bind:
      create_host_path: true
```

## ğŸš¨ æ•…éšœæ’é™¤

### ä¿®å¤å¤±è´¥çš„å¸¸è§åŸå› 

1. **æƒé™ä¸è¶³**
   ```bash
   # è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨sudo
   sudo ./emergency_force_fix.sh
   ```

2. **DockeræœåŠ¡é—®é¢˜**
   ```bash
   # é‡å¯DockeræœåŠ¡
   sudo systemctl restart docker
   ```

3. **ç«¯å£å ç”¨**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tlnp | grep 5000
   # æ€æ­»å ç”¨è¿›ç¨‹
   sudo kill -9 <PID>
   ```

4. **ç£ç›˜ç©ºé—´ä¸è¶³**
   ```bash
   # æ£€æŸ¥ç£ç›˜ç©ºé—´
   df -h
   # æ¸…ç†Docker
   docker system prune -a
   ```

### éªŒè¯ä¿®å¤æˆåŠŸ

1. **å®¹å™¨çŠ¶æ€æ£€æŸ¥**
   ```bash
   docker ps | grep cbit-aistudio
   # åº”è¯¥æ˜¾ç¤ºå®¹å™¨æ­£åœ¨è¿è¡Œ
   ```

2. **åº”ç”¨å¥åº·æ£€æŸ¥**
   ```bash
   curl http://localhost:5000/health
   # åº”è¯¥è¿”å›å¥åº·çŠ¶æ€JSON
   ```

3. **æ•°æ®åº“è¿æ¥æµ‹è¯•**
   ```bash
   python3 test_local_db.py
   # åº”è¯¥æ˜¾ç¤ºè¿æ¥æˆåŠŸ
   ```

4. **æ—¥å¿—æ£€æŸ¥**
   ```bash
   docker logs cbit-aistudio --tail 20
   # ä¸åº”è¯¥æœ‰æƒé™é”™è¯¯
   ```

## ğŸ“ ç´§æ€¥æ”¯æŒ

### å¦‚æœæ‰€æœ‰ä¿®å¤æ–¹æ¡ˆéƒ½å¤±è´¥

1. **å®Œå…¨é‡ç½®ç¯å¢ƒ**
   ```bash
   # åœæ­¢æ‰€æœ‰æœåŠ¡
   docker-compose down
   docker system prune -a
   
   # åˆ é™¤é¡¹ç›®ç›®å½•
   sudo rm -rf instance downloads static/uploads
   
   # é‡æ–°æ‹‰å–ä»£ç 
   git pull origin main
   
   # è¿è¡Œå¼ºåˆ¶ä¿®å¤
   sudo ./emergency_force_fix.sh
   ```

2. **æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ**
   ```bash
   # æ£€æŸ¥Dockerç‰ˆæœ¬
   docker --version
   docker-compose --version
   
   # æ£€æŸ¥ç³»ç»Ÿæƒé™
   whoami
   groups
   
   # æ£€æŸ¥SELinuxçŠ¶æ€ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
   sestatus
   ```

3. **è”ç³»æŠ€æœ¯æ”¯æŒ**
   - æä¾›å®Œæ•´çš„é”™è¯¯æ—¥å¿—
   - æä¾›ç³»ç»Ÿç¯å¢ƒä¿¡æ¯
   - æä¾›ä¿®å¤è„šæœ¬æ‰§è¡Œæ—¥å¿—

## ğŸ¯ é¢„é˜²æªæ–½

### é¿å…æƒé™é—®é¢˜å†æ¬¡å‘ç”Ÿ

1. **å®šæœŸæƒé™æ£€æŸ¥**
   ```bash
   # æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡
   0 2 * * * cd /path/to/project && ./baota_manage.sh fix-permissions
   ```

2. **ç›‘æ§å®¹å™¨çŠ¶æ€**
   ```bash
   # å¥åº·æ£€æŸ¥å®šæ—¶ä»»åŠ¡
   */5 * * * * curl -f http://localhost:5000/health || echo "åº”ç”¨å¼‚å¸¸" | mail -s "CBITå¼‚å¸¸" admin@example.com
   ```

3. **å®šæœŸå¤‡ä»½**
   ```bash
   # æ•°æ®åº“å¤‡ä»½
   0 3 * * * cp /path/to/instance/local_cache.db /backup/cbit_$(date +\%Y\%m\%d).db
   ```

## âœ… æˆåŠŸæ ‡å¿—

ä¿®å¤æˆåŠŸåï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

- âœ… å®¹å™¨æ­£å¸¸è¿è¡Œï¼š`docker ps | grep cbit-aistudio`
- âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼š`curl http://localhost:5000/health`
- âœ… æ— æƒé™é”™è¯¯ï¼š`docker logs cbit-aistudio`
- âœ… æ•°æ®åº“æ­£å¸¸ï¼š`python3 test_local_db.py`
- âœ… åº”ç”¨å¯è®¿é—®ï¼šæµè§ˆå™¨æ‰“å¼€ `http://localhost:5000`

---

**ğŸ‰ ä½¿ç”¨è¿™äº›ç»ˆæä¿®å¤æ–¹æ¡ˆï¼Œä½ çš„æ•°æ®åº“æƒé™é—®é¢˜å°†å½»åº•è§£å†³ï¼**
