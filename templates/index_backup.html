<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>baiducbit AI Studio - FLUXç¿»è¯‘å·¥ä½œæµ</title>
    
    <!-- å¤–éƒ¨èµ„æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Tailwindé…ç½® - è°ƒæ•´ä¸ºæµ…è‰²ä¸»é¢˜ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#7c3aed',
                        light: '#f8fafc',
                        dark: '#e2e8f0',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- è‡ªå®šä¹‰å·¥å…·ç±» - é€‚é…æµ…è‰²ä¸»é¢˜ -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .glass-effect { @apply bg-white/80 backdrop-blur-sm border border-gray-200 shadow-sm; }
            .card-hover { @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1; }
            .btn-primary { @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200; }
            .btn-secondary { @apply bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg transition-all duration-200; }
            .tab-active { @apply bg-primary text-white; }
            .tab-inactive { @apply bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors; }
        }
    </style>
</head>
<body class="font-inter bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 min-h-screen flex flex-col">
    <!-- å¯¼èˆªæ  -->
    <header class="glass-effect sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary">
                    Baidu&CBIT AI Studio - Fluxæ‹ŸçœŸç”Ÿæˆå¹³å°
                </h1>
            </div>
            
            <div class="flex items-center space-x-3">
                <button class="btn-secondary text-sm hidden sm:block" id="queue-btn">
                    <i class="fa fa-list mr-1"></i> é˜Ÿåˆ—çŠ¶æ€
                </button>
                <button class="btn-secondary text-sm hidden sm:block" id="interrupt-btn" disabled>
                    <i class="fa fa-stop mr-1"></i> ä¸­æ–­ç”Ÿæˆ
                </button>
                <div class="w-9 h-9 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center cursor-pointer hover:scale-105 transition-transform">
                    <i class="fa fa-user text-white"></i>
                </div>
            </div>
    </div>
  </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
            <div class="lg:col-span-1 space-y-6">
                <!-- åŠŸèƒ½æ ‡ç­¾é¡µåˆ‡æ¢ -->
                <div class="glass-effect rounded-xl overflow-hidden">
                    <div class="flex border-b border-gray-200">
                        <button class="mode-btn tab-active flex-1 py-3 px-4 font-medium transition-all" data-mode="txt2img">
                            <i class="fa fa-file-text-o mr-2"></i>æ–‡æœ¬ç”Ÿå›¾
                        </button>
                        <button class="mode-btn tab-inactive flex-1 py-3 px-4 font-medium transition-all" data-mode="img2vid">
                            <i class="fa fa-video-camera mr-2"></i>è§†é¢‘ç”Ÿæˆ
                        </button>
      </div>


                    
                    <!-- æ–‡æœ¬ç”Ÿå›¾å†…å®¹åŒº -->
                    <div class="mode-content p-5" id="txt2img-content">
                        <div class="space-y-6">
                            <div>
                                <h2 class="text-lg font-semibold mb-3 flex items-center">
                                    <i class="fa fa-comment-o text-primary mr-2"></i> è‹±æ–‡æç¤ºè¯
                                </h2>
                                <textarea id="prompt" class="w-full bg-white border border-gray-300 rounded-lg p-3 h-32 resize-none focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all shadow-sm" placeholder="Enter English prompt, e.g.: realistic portrait of asian girl, natural lighting..."></textarea>
                                
                                <div class="mt-3 text-sm text-gray-500 flex justify-between">
                                    <span>è‹±æ–‡æç¤ºè¯æ•ˆæœæ›´ä½³</span>
                                    <span id="charCount">0/500</span>
                                </div>
                                
                                <div class="mt-3">
                                    <h3 class="text-sm font-medium text-gray-700 mb-2">Professional Prompts</h3>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                        <!-- Portrait Photography -->
                                        <div class="space-y-1">
                                            <h4 class="text-xs font-medium text-gray-600">Portrait Photography</h4>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-blue-50 hover:bg-blue-100 rounded transition-colors text-left" data-prompt="professional studio portrait of elegant asian woman, wearing sophisticated blazer, against clean white background, dramatic lighting with softbox, sharp focus on eyes, high-end fashion photography style, 85mm lens, shallow depth of field">Studio Fashion Portrait</button>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-blue-50 hover:bg-blue-100 rounded transition-colors text-left" data-prompt="natural light portrait of asian man in urban setting, wearing casual denim jacket, golden hour lighting, modern city architecture background, candid expression, street photography aesthetic, 50mm lens, authentic lifestyle moment">Urban Lifestyle Portrait</button>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-blue-50 hover:bg-blue-100 rounded transition-colors text-left" data-prompt="environmental portrait of young asian woman in traditional tea house, wearing modern hanbok, soft diffused lighting through paper windows, cultural heritage meets contemporary style, medium shot composition, film photography aesthetic">Cultural Heritage Portrait</button>
                                        </div>
                                        
                                        <!-- Lifestyle Scenes -->
                                        <div class="space-y-1">
                                            <h4 class="text-xs font-medium text-gray-600">Lifestyle Scenes</h4>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-green-50 hover:bg-green-100 rounded transition-colors text-left" data-prompt="cozy coffee shop scene, asian woman reading book by window, steaming latte on wooden table, afternoon sunlight streaming through blinds, warm ambient lighting, shallow depth of field, lifestyle photography, authentic candid moment">Coffee Shop Reading</button>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-green-50 hover:bg-green-100 rounded transition-colors text-left" data-prompt="home kitchen scene, young mother and child baking together, flour dusted on marble counter, warm pendant lighting, natural family interaction, documentary style photography, 35mm lens, genuine emotions captured">Family Baking Moment</button>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-green-50 hover:bg-green-100 rounded transition-colors text-left" data-prompt="cherry blossom park, couple walking hand in hand under pink petals, spring afternoon light, romantic atmosphere, other visitors blurred in background, natural lifestyle photography, soft focus on subjects">Spring Romance Walk</button>
                                        </div>
                                        
                                        <!-- Artistic Styles -->
                                        <div class="space-y-1">
                                            <h4 class="text-xs font-medium text-gray-600">Artistic Styles</h4>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-purple-50 hover:bg-purple-100 rounded transition-colors text-left" data-prompt="cyberpunk style portrait of asian woman with tech glasses, neon-lit urban night scene, holographic advertisements reflecting on wet streets, cool color palette, futuristic aesthetic, high contrast lighting, cinematic composition">Cyberpunk Future</button>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-purple-50 hover:bg-purple-100 rounded transition-colors text-left" data-prompt="watercolor painting style, woman in white dress standing in lavender field, soft mountain backdrop, dreamy clouds, ethereal and romantic atmosphere, Studio Ghibli inspired aesthetic, pastel color palette, artistic illustration">Lavender Field Dream</button>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-purple-50 hover:bg-purple-100 rounded transition-colors text-left" data-prompt="vintage film photography style, 1990s Hong Kong cha chaan teng, young man in checkered shirt sitting in red booth, classic milk tea and pineapple bun on table, warm tungsten lighting, nostalgic grain texture">Hong Kong Nostalgia</button>
                                        </div>
                                        
                                        <!-- Professional Photography -->
                                        <div class="space-y-1">
                                            <h4 class="text-xs font-medium text-gray-600">Professional Photography</h4>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-orange-50 hover:bg-orange-100 rounded transition-colors text-left" data-prompt="high-end fashion magazine cover style, model in designer suit, minimalist white studio background, professional lighting setup, sharp facial features, confident gaze, commercial photography quality, medium format camera aesthetic">Magazine Cover Style</button>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-orange-50 hover:bg-orange-100 rounded transition-colors text-left" data-prompt="golden hour beach portrait, model sitting on driftwood, ocean waves in background, hair flowing in sea breeze, sunset lighting creating rim light, natural beauty concept, environmental portrait, 85mm telephoto lens">Golden Hour Beach</button>
                                            <button class="preset-btn w-full text-xs px-2 py-1 bg-orange-50 hover:bg-orange-100 rounded transition-colors text-left" data-prompt="black and white street photography, woman with transparent umbrella walking in rain, city reflections on wet pavement, dramatic contrast, film noir aesthetic, high contrast lighting, artistic composition, 35mm street photography">Rainy Night Poetry</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h2 class="text-lg font-semibold mb-3 flex items-center">
                                    <i class="fa fa-ban text-primary mr-2"></i> åå‘æç¤ºè¯
                                </h2>
                                <textarea id="negative" class="w-full bg-white border border-gray-300 rounded-lg p-3 h-20 resize-none focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all shadow-sm" placeholder="æè¿°ä¸æƒ³è¦çš„å†…å®¹ï¼ˆå¯ç•™ç©ºï¼‰"></textarea>
                            </div>
                        </div>
            </div>
          </div>

                    <!-- è§†é¢‘ç”Ÿæˆå†…å®¹åŒº -->
                    <div class="mode-content p-5 hidden" id="img2vid-content">
                        <div class="space-y-6">
                            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                            <div>
                                <h2 class="text-lg font-semibold mb-3 flex items-center">
                                    <i class="fa fa-image text-primary mr-2"></i> ä¸Šä¼ å›¾ç‰‡
                                    <span class="text-xs bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-2 py-1 rounded ml-2">CBIT Pro</span>
                                </h2>
                                <div id="image-upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer">
                                    <div id="upload-prompt">
                                        <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-4"></i>
                                        <p class="text-gray-600 mb-2">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</p>
                                        <p class="text-sm text-gray-400">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®åˆ†è¾¨ç‡ä¸è¶…è¿‡ 2048x2048</p>
                                        <p class="text-xs text-yellow-600 mt-1">ğŸ¬ CBIT Proæ”¯æŒ1080Pé«˜æ¸…è§†é¢‘ç”Ÿæˆï¼Œå¤šé•œå¤´å™äº‹èƒ½åŠ›</p>
                                        <input type="file" id="image-input" accept="image/*" class="hidden">
                                    </div>
                                    <div id="image-preview" class="hidden">
                                        <img id="preview-img" src="" alt="é¢„è§ˆå›¾ç‰‡" class="max-w-full max-h-64 mx-auto rounded-lg">
                                        <p class="mt-2 text-sm text-gray-600" id="image-filename"></p>
                                        <button id="remove-image" class="mt-2 text-red-500 hover:text-red-700 text-sm">
                                            <i class="fa fa-trash mr-1"></i>ç§»é™¤å›¾ç‰‡
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- ä¸­æ–‡æç¤ºè¯ -->
                            <div>
                                <h2 class="text-lg font-semibold mb-3 flex items-center">
                                    <i class="fa fa-comment-o text-primary mr-2"></i> ä¸­æ–‡æç¤ºè¯
                                </h2>
                                <textarea id="video-prompt" class="w-full bg-white border border-gray-300 rounded-lg p-3 h-32 resize-none focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all shadow-sm" placeholder="è¯·è¾“å…¥ä¸­æ–‡æè¿°ï¼Œä¾‹å¦‚ï¼šåƒå†›ä¸‡é©¬ã€æµ·æµªæ‹æ‰“å²¸è¾¹ã€æ¨±èŠ±é£˜è½ç­‰..."></textarea>
                                
                                <div class="mt-3 text-sm text-gray-500 flex justify-between">
                                    <span>ä»…æ”¯æŒä¸­æ–‡ï¼Œå»ºè®®400å­—ä»¥å†…</span>
                                    <span id="video-charCount">0/400</span>
                                </div>
                                
                                <!-- é¢„è®¾æç¤ºè¯ -->
                                <div class="mt-3">
                                    <h3 class="text-sm font-medium text-gray-700 mb-2">çƒ­é—¨è§†é¢‘æ•ˆæœ</h3>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button class="video-preset-btn text-xs px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded transition-colors text-left" data-prompt="åƒå†›ä¸‡é©¬å¥”è…¾åœ¨å¹¿é˜”çš„è‰åŸä¸Šï¼Œå°˜åœŸé£æ‰¬ï¼Œæ°”åŠ¿æ¢å®">åƒå†›ä¸‡é©¬</button>
                                        <button class="video-preset-btn text-xs px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded transition-colors text-left" data-prompt="æµ·æµªæ‹æ‰“åœ¨ç¤çŸ³ä¸Šï¼Œæ°´èŠ±å››æº…ï¼Œé˜³å…‰ç…§å°„ä¸‹æ³¢å…‰ç²¼ç²¼">æµ·æµªæ‹å²¸</button>
                                        <button class="video-preset-btn text-xs px-3 py-2 bg-green-50 hover:bg-green-100 rounded transition-colors text-left" data-prompt="æ¨±èŠ±èŠ±ç“£åœ¨æ˜¥é£ä¸­é£˜è½ï¼Œç²‰è‰²èŠ±ç“£æ»¡å¤©é£èˆï¼Œå”¯ç¾æµªæ¼«">æ¨±èŠ±é£˜è½</button>
                                        <button class="video-preset-btn text-xs px-3 py-2 bg-green-50 hover:bg-green-100 rounded transition-colors text-left" data-prompt="åŸå¸‚å¤œæ™¯ä¸­éœ“è™¹ç¯é—ªçƒï¼Œè½¦æµå¦‚æ²³ï¼Œç¯ç«è¾‰ç…Œ">éƒ½å¸‚å¤œæ™¯</button>
                                        <button class="video-preset-btn text-xs px-3 py-2 bg-purple-50 hover:bg-purple-100 rounded transition-colors text-left" data-prompt="æ£®æ—ä¸­é˜³å…‰é€è¿‡æ ‘å¶æ´’ä¸‹æ–‘é©³å…‰å½±ï¼Œå¾®é£è½»æ‹‚æ ‘å¶">æ£®æ—å…‰å½±</button>
                                        <button class="video-preset-btn text-xs px-3 py-2 bg-purple-50 hover:bg-purple-100 rounded transition-colors text-left" data-prompt="é›ªèŠ±çº·é£çš„å†¬æ—¥ï¼Œé›ªèŠ±åœ¨ç©ºä¸­ç¿©ç¿©èµ·èˆï¼Œé“¶è£…ç´ è£¹">é›ªèŠ±é£èˆ</button>
                                    </div>
                                </div>
                            </div>

                            <!-- è§†é¢‘å‚æ•°è®¾ç½® -->
                            <div>
                                <h2 class="text-lg font-semibold mb-3 flex items-center">
                                    <i class="fa fa-cog text-primary mr-2"></i> è§†é¢‘å‚æ•°
                                </h2>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <!-- è§†é¢‘æ—¶é•¿ -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">è§†é¢‘æ—¶é•¿</label>
                                        <select id="video-duration" class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-primary/50">
                                            <option value="121">5ç§’ (121å¸§)</option>
                                            <option value="241">10ç§’ (241å¸§)</option>
                                        </select>
                                    </div>
                                    
                                    <!-- å®½é«˜æ¯” -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">å®½é«˜æ¯”</label>
                                        <select id="video-aspect" class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-primary/50">
                                            <option value="16:9">16:9 (æ¨ªå±)</option>
                                            <option value="9:16">9:16 (ç«–å±)</option>
                                            <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                                            <option value="4:3">4:3 (æ ‡å‡†)</option>
                                            <option value="3:4">3:4 (ç«–ç‰ˆæ ‡å‡†)</option>
                                            <option value="21:9">21:9 (è¶…å®½å±)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- éšæœºç§å­ -->
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">éšæœºç§å­ (å¯é€‰)</label>
                                    <input type="number" id="video-seed" class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="-1 (éšæœº)" value="-1">
                                    <p class="text-xs text-gray-500 mt-1">ç›¸åŒç§å­å’Œå‚æ•°ä¼šç”Ÿæˆç›¸ä¼¼çš„è§†é¢‘æ•ˆæœ</p>
                                </div>
                            </div>

                            <!-- ç”ŸæˆæŒ‰é’® -->
                            <div>
                                <button id="generate-video-btn" class="w-full btn-primary py-3 text-lg font-semibold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fa fa-video-camera mr-2"></i>ç”Ÿæˆè§†é¢‘ <span class="text-xs bg-yellow-500 text-black px-2 py-1 rounded ml-2">Pro</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å‚æ•°è®¾ç½® -->
                <div class="glass-effect rounded-xl p-5 card-hover">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-sliders text-primary mr-2"></i> å‚æ•°è®¾ç½®
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">å›¾åƒå°ºå¯¸</label>
                            <select id="size" class="w-full bg-white border border-gray-300 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-sm">
                                <option value="896x1392">896Ã—1392 (ç«–å›¾)</option>
                                <option value="1392x896">1392Ã—896 (æ¨ªå›¾)</option>
                                <option value="1024x1024">1024Ã—1024 (æ–¹å›¾)</option>
                                <option value="768x1152">768Ã—1152 (å°ç«–å›¾)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">é‡‡æ ·æ­¥æ•°: <span id="stepsValue">30</span></label>
                            <input type="range" min="10" max="50" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary" id="steps">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">å¼•å¯¼åº¦: <span id="guidanceValue">3.0</span></label>
                            <input type="range" min="1" max="10" step="0.1" value="3.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary" id="guidance">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">éšæœºç§å­</label>
                            <input type="number" id="seed" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ" class="w-full bg-white border border-gray-300 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-sm">
                        </div>
                        
                        <!-- é«˜çº§è®¾ç½®æŠ˜å é¢æ¿ -->
                        <details class="border border-gray-200 rounded-lg">
                            <summary class="p-3 bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors rounded-lg">
                                <i class="fa fa-cog mr-2"></i>é«˜çº§è®¾ç½®
                            </summary>
                            <div class="p-3 space-y-3">
          <div>
                                    <label class="block text-sm text-gray-600 mb-1">å™ªå£°æ³¨å…¥: <span id="noiseValue">0.85</span></label>
                                    <input type="range" min="0" max="1" step="0.01" value="0.85" class="w-full accent-primary" id="noise-injection">
          </div>
          <div>
                                    <label class="block text-sm text-gray-600 mb-1">é”åŒ–å¼ºåº¦: <span id="sharpenValue">0.69</span></label>
                                    <input type="range" min="0" max="2" step="0.01" value="0.69" class="w-full accent-primary" id="sharpening-strength">
          </div>
          <div>
                                    <label class="block text-sm text-gray-600 mb-1">èƒ¶ç‰‡é¢—ç²’: <span id="grainValue">0.05</span></label>
                                    <input type="range" min="0" max="0.2" step="0.01" value="0.05" class="w-full accent-primary" id="film-grain-strength">
          </div>
        </div>
      </details>
                    </div>
                </div>
                
                <!-- ç”ŸæˆæŒ‰é’® -->
                <button id="generate-btn" class="w-full btn-primary text-lg py-3 flex items-center justify-center">
                    <i class="fa fa-magic mr-2"></i> ç”Ÿæˆå›¾åƒ
                </button>
            </div>
            
            <!-- å³ä¾§ï¼šç»“æœå±•ç¤ºåŒº -->
            <div class="lg:col-span-2 space-y-6">
                <!-- çŠ¶æ€æ˜¾ç¤º -->
                <div class="glass-effect rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-info-circle text-primary mr-2"></i> çŠ¶æ€
                        </h2>
                        <div class="status px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm" id="status">å°±ç»ª</div>
                    </div>
                </div>
                
                <!-- ç”Ÿæˆç»“æœ -->
                <div class="glass-effect rounded-xl p-5 card-hover">
                    <h2 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fa fa-image text-primary mr-2"></i> ç”Ÿæˆç»“æœ
                    </h2>
                    
                    <!-- è¿›åº¦æ¡å®¹å™¨ -->
                    <div id="progress-container" class="hidden mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700" id="progress-text">ç”Ÿæˆä¸­...</span>
                            <span class="text-sm text-gray-500" id="progress-percentage">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progress-bar" class="bg-gradient-to-r from-primary to-secondary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                            <span id="current-step">æ­¥éª¤: 0/30</span>
                            <span id="estimated-time">é¢„è®¡: --:--</span>
                        </div>
      </div>

                    <div id="results">
                        <div class="placeholder flex flex-col items-center justify-center py-16 text-center">
                            <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                                <i class="fa fa-paint-brush text-3xl text-gray-400"></i>
                            </div>
                            <p class="text-gray-500 max-w-md">é€‰æ‹©åŠŸèƒ½ç±»å‹ï¼Œè®¾ç½®å‚æ•°åç‚¹å‡»"ç”Ÿæˆå›¾åƒ"æŒ‰é’®å¼€å§‹åˆ›ä½œ</p>
                            <p class="text-sm text-gray-400 mt-2">æ”¯æŒä¸­æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡ç­‰å¤šè¯­è¨€è¾“å…¥</p>
                            <p class="text-sm text-gray-400">é›†æˆé«˜çº§Fluxæ¨¡å‹å’Œåå¤„ç†åŠŸèƒ½</p>
        </div>
        </div>
        
        
      </div>

                <!-- APIæµ‹è¯•åŒº -->
                <div class="glass-effect rounded-xl p-5 card-hover">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-flask text-primary mr-2"></i> APIæµ‹è¯•
                        </h2>
                        <button id="test-api-btn" class="btn-secondary text-sm">
                            <i class="fa fa-play mr-1"></i>æµ‹è¯•API
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div class="bg-white border border-gray-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-600" id="health-status">-</div>
                            <div class="text-sm text-gray-600">å¥åº·æ£€æŸ¥</div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="lora-status">-</div>
                            <div class="text-sm text-gray-600">LoRAé¢„è®¾</div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-purple-600" id="queue-status">-</div>
                            <div class="text-sm text-gray-600">é˜Ÿåˆ—çŠ¶æ€</div>
                        </div>
                    </div>
                </div>
        </div>
        </div>
    </main>

    <script>
        let currentMode = 'txt2img';
        let currentPromptId = null;
        let checkInterval = null;
        let checkCount = 0;
        let maxCheckCount = 300; // æœ€å¤šæ£€æŸ¥5åˆ†é’Ÿ (300 * 1ç§’)

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            initRangeInputs();
            testAPIs();
        });

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mode-btn').forEach(b => {
                        b.classList.remove('tab-active');
                        b.classList.add('tab-inactive');
                    });
                    document.querySelectorAll('.mode-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    this.classList.remove('tab-inactive');
                    this.classList.add('tab-active');
                    currentMode = this.dataset.mode;
                    
                    document.getElementById(`${currentMode}-content`).classList.remove('hidden');
                });
            });

            // é¢„è®¾æŒ‰é’®
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.dataset.text) {
                        document.getElementById('original-text').value = this.dataset.text;
                    }
                    if (this.dataset.prompt) {
                        document.getElementById('prompt').value = this.dataset.prompt;
                    }
                });
            });

            // å­—ç¬¦è®¡æ•°
            const promptTextarea = document.getElementById('prompt');
            const charCount = document.getElementById('charCount');
            if (promptTextarea && charCount) {
                promptTextarea.addEventListener('input', function() {
                    const count = Math.min(this.value.length, 500);
                    this.value = this.value.substring(0, 500);
                    charCount.textContent = `${count}/500`;
                    charCount.classList.toggle('text-red-400', count === 500);
                });
            }

            // ç”ŸæˆæŒ‰é’®
            document.getElementById('generate-btn').addEventListener('click', generateImage);
            
            // ä¸­æ–­æŒ‰é’®
            document.getElementById('interrupt-btn').addEventListener('click', interruptGeneration);
            
            // é˜Ÿåˆ—æŒ‰é’®
            document.getElementById('queue-btn').addEventListener('click', checkQueue);
            
            // APIæµ‹è¯•æŒ‰é’®
            document.getElementById('test-api-btn').addEventListener('click', testAPIs);
        }

        // åˆå§‹åŒ–èŒƒå›´è¾“å…¥
        function initRangeInputs() {
            const ranges = [
                {id: 'steps', valueId: 'stepsValue'},
                {id: 'guidance', valueId: 'guidanceValue'},
                {id: 'noise-injection', valueId: 'noiseValue'},
                {id: 'sharpening-strength', valueId: 'sharpenValue'},
                {id: 'film-grain-strength', valueId: 'grainValue'}
            ];
            
            ranges.forEach(range => {
                const input = document.getElementById(range.id);
                const valueSpan = document.getElementById(range.valueId);
                if (input && valueSpan) {
                    input.addEventListener('input', function() {
                        valueSpan.textContent = this.value;
                    });
                }
            });
        }

        // ç”Ÿæˆå›¾åƒ
        async function generateImage() {
            const generateBtn = document.getElementById('generate-btn');
            const interruptBtn = document.getElementById('interrupt-btn');
            const status = document.getElementById('status');
            const progressContainer = document.getElementById('progress-container');
            const results = document.getElementById('results');
            
            try {
                // æ¸…ç†ä¹‹å‰çš„çŠ¶æ€
                if (checkInterval) {
                    clearInterval(checkInterval);
                    checkInterval = null;
                }
                if (progressSimulation) {
                    clearInterval(progressSimulation);
                    progressSimulation = null;
                }
                currentPromptId = null;
                
                generateBtn.disabled = true;
                interruptBtn.disabled = false;
                status.textContent = 'æ­£åœ¨ç”Ÿæˆ...';
                status.className = 'status px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm';
                
                // å®Œå…¨é‡ç½®UIçŠ¶æ€
                results.innerHTML = '';
                progressContainer.classList.remove('hidden');
                
                // å¼ºåˆ¶é‡ç½®è¿›åº¦æ¡ - é˜²æ­¢æ®‹ç•™æ˜¾ç¤º
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-percentage').textContent = '0%';
                document.getElementById('progress-text').textContent = 'å‡†å¤‡ä¸­...';
                
                // åˆå§‹åŒ–è¿›åº¦æ¡
                initProgressBar();
                
                const data = collectFormData();
                
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                currentPromptId = result.prompt_id;
                status.textContent = `ä»»åŠ¡å·²æäº¤ (${result.prompt_id.substring(0, 8)}...)`;
                
                // å¼€å§‹æ£€æŸ¥ç»“æœå’Œæ›´æ–°è¿›åº¦
                checkInterval = setInterval(checkResult, 1000);
                
            } catch (error) {
                status.textContent = `é”™è¯¯: ${error.message}`;
                status.className = 'status px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm';
                progressContainer.classList.add('hidden');
                generateBtn.disabled = false;
                interruptBtn.disabled = true;
                currentPromptId = null;
                showPlaceholder();
            }
        }

        // æ”¶é›†è¡¨å•æ•°æ®
        function collectFormData() {
            const size = document.getElementById('size').value.split('x');
            const data = {
                mode: 'txt2img',
                width: parseInt(size[0]),
                height: parseInt(size[1]),
                steps: parseInt(document.getElementById('steps').value),
                guidance: parseFloat(document.getElementById('guidance').value),
                seed: document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : null,
                noise_injection: parseFloat(document.getElementById('noise-injection').value),
                sharpening_strength: parseFloat(document.getElementById('sharpening-strength').value),
                film_grain_strength: parseFloat(document.getElementById('film-grain-strength').value),
                prompt: document.getElementById('prompt').value,
                negative_prompt: document.getElementById('negative').value
            };

            return data;
        }

        // æ£€æŸ¥ç»“æœ
        async function checkResult() {
            if (!currentPromptId) return;
            
            // æ£€æŸ¥è¶…æ—¶
            checkCount++;
            if (checkCount > maxCheckCount) {
                console.error('æ£€æŸ¥è¶…æ—¶ï¼Œåœæ­¢æ£€æŸ¥');
                document.getElementById('status').textContent = 'ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•';
                document.getElementById('status').className = 'status px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm';
                stopChecking();
                showPlaceholder();
                return;
            }
            
            try {
                const response = await fetch(`/api/result?prompt_id=${currentPromptId}`);
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    console.error(`HTTPé”™è¯¯: ${response.status}`);
                    return;
                }
                
                // è·å–å“åº”æ–‡æœ¬å¹¶æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆJSON
                const responseText = await response.text();
                if (!responseText || responseText.trim() === '') {
                    console.log('æ”¶åˆ°ç©ºå“åº”ï¼Œç»§ç»­ç­‰å¾…...');
                    return;
                }
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (jsonError) {
                    console.error('JSONè§£æå¤±è´¥:', jsonError);
                    console.log('å“åº”å†…å®¹:', responseText);
                    return;
                }
                
                if (result.status === 'success' && result.images) {
                    // å®Œæˆè¿›åº¦æ¡
                    updateProgress(100, 'ç”Ÿæˆå®Œæˆï¼', parseInt(document.getElementById('steps').value), parseInt(document.getElementById('steps').value), '00:00');
                    setTimeout(() => {
                        displayResults(result.images);
                        stopChecking();
                    }, 1000);
                } else if (result.status === 'error') {
                    document.getElementById('status').textContent = `é”™è¯¯: ${result.message}`;
                    document.getElementById('status').className = 'status px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm';
                    stopChecking();
                    showPlaceholder();
                } else if (result.status === 'pending' || result.status === 'running') {
                    // å¦‚æœè¿˜æ²¡æœ‰å¯åŠ¨è¿›åº¦æ¨¡æ‹Ÿï¼Œå°±å¯åŠ¨å®ƒ
                    if (!progressSimulation) {
                        const totalSteps = parseInt(document.getElementById('steps').value) || 30;
                        setTimeout(() => simulateProgress(totalSteps), 2000); // å»¶è¿Ÿ2ç§’å¼€å§‹æ¨¡æ‹Ÿ
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç»“æœå¤±è´¥:', error);
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œç»§ç»­é‡è¯•ï¼›å¦‚æœæ˜¯å…¶ä»–é”™è¯¯ï¼Œåœæ­¢æ£€æŸ¥
                if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                    console.log('ç½‘ç»œé”™è¯¯ï¼Œç»§ç»­é‡è¯•...');
                } else {
                    console.error('ä¸¥é‡é”™è¯¯ï¼Œåœæ­¢æ£€æŸ¥:', error);
                    stopChecking();
                }
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(images) {
            const results = document.getElementById('results');
            const progressContainer = document.getElementById('progress-container');
            
            // æ¸…ç©ºç»“æœå®¹å™¨
            results.innerHTML = '';
            
            // éšè—è¿›åº¦æ¡
            progressContainer.classList.add('hidden');
            
            images.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'result-item mb-4';
                div.innerHTML = `
                    <div class="relative rounded-lg overflow-hidden bg-white border border-gray-200 shadow-sm">
                        <img src="${img.url}" alt="ç”Ÿæˆçš„å›¾åƒ ${index + 1}" class="w-full h-auto" />
                        <div class="absolute inset-0 bg-black/10 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center space-x-3">
                            <button class="bg-white text-gray-800 p-2 rounded-full hover:bg-gray-100 transition-colors shadow-sm" onclick="downloadImage('${img.url}', '${img.filename}')" title="ä¸‹è½½å›¾ç‰‡">
                                <i class="fa fa-download"></i>
                            </button>
                            <button class="bg-white text-gray-800 p-2 rounded-full hover:bg-gray-100 transition-colors shadow-sm" onclick="regenerateImage()" title="é‡æ–°ç”Ÿæˆ">
                                <i class="fa fa-refresh"></i>
                            </button>
                            <button class="bg-white text-gray-800 p-2 rounded-full hover:bg-gray-100 transition-colors shadow-sm" onclick="openVideoModal('${img.url}')" title="ç”Ÿæˆè§†é¢‘">
                                <i class="fa fa-video-camera"></i>
                            </button>
        </div>
      </div>
                    <div class="mt-2 text-sm text-gray-500 text-center">${img.filename}</div>
                `;
                results.appendChild(div);
            });
            
            document.getElementById('status').textContent = 'ç”Ÿæˆå®Œæˆ';
            document.getElementById('status').className = 'status px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm';
        }

        // åˆå§‹åŒ–è¿›åº¦æ¡
        function initProgressBar() {
            const data = collectFormData();
            const totalSteps = data.steps || 30;
            
            // å¼ºåˆ¶é‡ç½®æ‰€æœ‰è¿›åº¦æ¡å…ƒç´ 
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressText = document.getElementById('progress-text');
            const currentStepEl = document.getElementById('current-step');
            const estimatedTimeEl = document.getElementById('estimated-time');
            
            // ä¸´æ—¶ç¦ç”¨è¿‡æ¸¡åŠ¨ç”»ä»¥ç«‹å³é‡ç½®
            progressBar.style.transition = 'none';
            progressBar.style.width = '0%';
            
            // é‡æ–°å¯ç”¨è¿‡æ¸¡åŠ¨ç”»
            setTimeout(() => {
                progressBar.style.transition = 'width 0.3s ease';
            }, 50);
            
            progressPercentage.textContent = '0%';
            progressText.textContent = 'æ­£åœ¨åˆå§‹åŒ–...';
            currentStepEl.textContent = `æ­¥éª¤: 0/${totalSteps}`;
            estimatedTimeEl.textContent = 'é¢„è®¡: è®¡ç®—ä¸­...';
            
            // æ¨¡æ‹Ÿåˆå§‹åŒ–è¿›åº¦
            setTimeout(() => {
                updateProgress(5, 'æ­£åœ¨åŠ è½½æ¨¡å‹...', 0, totalSteps);
            }, 500);
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percentage, text, currentStep, totalSteps, estimatedTime = null) {
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-percentage').textContent = `${Math.round(percentage)}%`;
            document.getElementById('progress-text').textContent = text;
            document.getElementById('current-step').textContent = `æ­¥éª¤: ${currentStep}/${totalSteps}`;
            
            if (estimatedTime) {
                document.getElementById('estimated-time').textContent = `é¢„è®¡: ${estimatedTime}`;
            }
        }

        // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
        let progressSimulation = null;
        function simulateProgress(totalSteps) {
            let currentStep = 0;
            let percentage = 10;
            const stepIncrement = 80 / totalSteps; // ç•™10%ç»™åˆå§‹åŒ–ï¼Œ10%ç»™åå¤„ç†
            
            progressSimulation = setInterval(() => {
                if (currentStep < totalSteps) {
                    currentStep++;
                    percentage += stepIncrement;
                    
                    let text = 'æ­£åœ¨ç”Ÿæˆå›¾åƒ...';
                    if (currentStep <= 5) {
                        text = 'æ­£åœ¨ç¼–ç æç¤ºè¯...';
                    } else if (currentStep <= totalSteps * 0.3) {
                        text = 'æ­£åœ¨åˆå§‹é‡‡æ ·...';
                    } else if (currentStep <= totalSteps * 0.7) {
                        text = 'æ­£åœ¨ç»†åŒ–å›¾åƒ...';
                    } else if (currentStep <= totalSteps * 0.9) {
                        text = 'æ­£åœ¨ä¼˜åŒ–ç»†èŠ‚...';
                    } else {
                        text = 'æ­£åœ¨åå¤„ç†...';
                    }
                    
                    const remainingTime = Math.max(0, (totalSteps - currentStep) * 2);
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    updateProgress(percentage, text, currentStep, totalSteps, timeStr);
                } else {
                    clearInterval(progressSimulation);
                    updateProgress(90, 'æ­£åœ¨ä¿å­˜å›¾åƒ...', totalSteps, totalSteps, '00:05');
                }
            }, 1500); // æ¯1.5ç§’æ›´æ–°ä¸€æ¬¡
        }

        // æ˜¾ç¤ºå ä½ç¬¦
        function showPlaceholder() {
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="placeholder flex flex-col items-center justify-center py-16 text-center">
                    <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                        <i class="fa fa-paint-brush text-3xl text-gray-400"></i>
                    </div>
                    <p class="text-gray-500 max-w-md">é€‰æ‹©åŠŸèƒ½ç±»å‹ï¼Œè®¾ç½®å‚æ•°åç‚¹å‡»"ç”Ÿæˆå›¾åƒ"æŒ‰é’®å¼€å§‹åˆ›ä½œ</p>
                    <p class="text-sm text-gray-400 mt-2">æ”¯æŒä¸­æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡ç­‰å¤šè¯­è¨€è¾“å…¥</p>
                    <p class="text-sm text-gray-400">é›†æˆé«˜çº§Fluxæ¨¡å‹å’Œåå¤„ç†åŠŸèƒ½</p>
                </div>
            `;
        }

        // åœæ­¢æ£€æŸ¥
        function stopChecking() {
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
            }
            if (progressSimulation) {
                clearInterval(progressSimulation);
                progressSimulation = null;
            }
            // é‡ç½®è¿›åº¦æ¡çŠ¶æ€
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('generate-btn').disabled = false;
            document.getElementById('interrupt-btn').disabled = true;
            
            // æ¸…ç†å½“å‰ä»»åŠ¡IDå’Œè®¡æ•°å™¨
            currentPromptId = null;
            checkCount = 0;
        }



        // ä¸­æ–­ç”Ÿæˆ
        async function interruptGeneration() {
            try {
                await fetch('/api/interrupt', { method: 'POST' });
                document.getElementById('status').textContent = 'å·²ä¸­æ–­';
                document.getElementById('status').className = 'status px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm';
                stopChecking();
            } catch (error) {
                console.error('ä¸­æ–­å¤±è´¥:', error);
            }
        }

        // æ£€æŸ¥é˜Ÿåˆ—
        async function checkQueue() {
            try {
                const response = await fetch('/api/queue');
                const queue = await response.json();
                alert(`é˜Ÿåˆ—çŠ¶æ€:\nè¿è¡Œä¸­: ${queue.queue_running?.length || 0}\nç­‰å¾…ä¸­: ${queue.queue_pending?.length || 0}`);
            } catch (error) {
                console.error('æ£€æŸ¥é˜Ÿåˆ—å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•API
        async function testAPIs() {
            // å¥åº·æ£€æŸ¥
            try {
                const response = await fetch('/health');
                document.getElementById('health-status').textContent = response.ok ? 'âœ“' : 'âœ—';
                document.getElementById('health-status').className = response.ok ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';
            } catch (error) {
                document.getElementById('health-status').textContent = 'âœ—';
                document.getElementById('health-status').className = 'text-2xl font-bold text-red-600';
            }

            // LoRAé¢„è®¾
            try {
                const response = await fetch('/api/lora/presets');
                const data = await response.json();
                document.getElementById('lora-status').textContent = Object.keys(data).length;
                document.getElementById('lora-status').className = 'text-2xl font-bold text-blue-600';
            } catch (error) {
                document.getElementById('lora-status').textContent = 'âœ—';
                document.getElementById('lora-status').className = 'text-2xl font-bold text-red-600';
            }

            // é˜Ÿåˆ—çŠ¶æ€
            try {
                const response = await fetch('/api/queue');
                const data = await response.json();
                const total = (data.queue_running?.length || 0) + (data.queue_pending?.length || 0);
                document.getElementById('queue-status').textContent = total;
                document.getElementById('queue-status').className = 'text-2xl font-bold text-purple-600';
            } catch (error) {
                document.getElementById('queue-status').textContent = 'âœ—';
                document.getElementById('queue-status').className = 'text-2xl font-bold text-red-600';
            }
        }

        // ä¸‹è½½å›¾åƒ
        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // é‡æ–°ç”Ÿæˆ
        function regenerateImage() {
            generateImage();
        }

        // è§†é¢‘ç”Ÿæˆç›¸å…³å˜é‡
        let currentVideoTaskId = null;
        let videoCheckInterval = null;

        // æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            const modeButtons = document.querySelectorAll('.mode-btn');
            const modeContents = document.querySelectorAll('.mode-content');
            
            modeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const mode = this.dataset.mode;
                    
                    // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
                    modeButtons.forEach(btn => {
                        btn.classList.remove('tab-active');
                        btn.classList.add('tab-inactive');
                    });
                    this.classList.remove('tab-inactive');
                    this.classList.add('tab-active');
                    
                    // åˆ‡æ¢å†…å®¹åŒºåŸŸ
                    modeContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(mode + '-content').classList.remove('hidden');
                });
            });

            // å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
            const imageUploadArea = document.getElementById('image-upload-area');
            const imageInput = document.getElementById('image-input');
            const uploadPrompt = document.getElementById('upload-prompt');
            const imagePreview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            const imageFilename = document.getElementById('image-filename');
            const removeImageBtn = document.getElementById('remove-image');

            imageUploadArea.addEventListener('click', () => imageInput.click());
            
            imageUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageUploadArea.classList.add('border-primary');
            });
            
            imageUploadArea.addEventListener('dragleave', () => {
                imageUploadArea.classList.remove('border-primary');
            });
            
            imageUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                imageUploadArea.classList.remove('border-primary');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageUpload(files[0]);
                }
            });
            
            imageInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            removeImageBtn.addEventListener('click', () => {
                uploadPrompt.classList.remove('hidden');
                imagePreview.classList.add('hidden');
                imageInput.value = '';
            });

            // è§†é¢‘æç¤ºè¯å­—ç¬¦è®¡æ•°
            const videoPrompt = document.getElementById('video-prompt');
            const videoCharCount = document.getElementById('video-charCount');
            const modalVideoPrompt = document.getElementById('modal-video-prompt');
            const modalCharCount = document.getElementById('modal-char-count');
            
            videoPrompt.addEventListener('input', function() {
                videoCharCount.textContent = `${this.value.length}/400`;
            });
            
            modalVideoPrompt.addEventListener('input', function() {
                modalCharCount.textContent = `${this.value.length}/400`;
            });

            // é¢„è®¾æç¤ºè¯ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.video-preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    videoPrompt.value = this.dataset.prompt;
                    videoCharCount.textContent = `${videoPrompt.value.length}/400`;
                });
            });
            
            document.querySelectorAll('.modal-preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    modalVideoPrompt.value = this.dataset.prompt;
                    modalCharCount.textContent = `${modalVideoPrompt.value.length}/400`;
                });
            });

            // è§†é¢‘ç”ŸæˆæŒ‰é’®
            document.getElementById('generate-video-btn').addEventListener('click', generateVideo);
            
            // æ¨¡æ€æ¡†æ§åˆ¶
            document.getElementById('close-video-modal').addEventListener('click', closeVideoModal);
            document.getElementById('cancel-video-modal').addEventListener('click', closeVideoModal);
            document.getElementById('confirm-generate-video').addEventListener('click', generateVideoFromModal);
        });

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(file) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('image-filename').textContent = file.name;
                    document.getElementById('upload-prompt').classList.add('hidden');
                    document.getElementById('image-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼');
            }
        }

        // æ‰“å¼€è§†é¢‘ç”Ÿæˆæ¨¡æ€æ¡†
        function openVideoModal(imageUrl) {
            document.getElementById('modal-source-image').src = imageUrl;
            document.getElementById('video-modal').classList.remove('hidden');
        }

        // å…³é—­è§†é¢‘ç”Ÿæˆæ¨¡æ€æ¡†
        function closeVideoModal() {
            document.getElementById('video-modal').classList.add('hidden');
            document.getElementById('modal-video-prompt').value = '';
            document.getElementById('modal-char-count').textContent = '0/400';
            
            // é‡ç½®è§†é¢‘ç»“æœåŒºåŸŸ
            const modalResults = document.getElementById('modal-video-results');
            const modalContent = document.getElementById('modal-video-content');
            if (modalResults) {
                modalResults.classList.add('hidden');
            }
            if (modalContent) {
                modalContent.innerHTML = '';
            }
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            resetModalButtons();
        }

        // ä»æ¨¡æ€æ¡†ç”Ÿæˆè§†é¢‘
        async function generateVideoFromModal() {
            const prompt = document.getElementById('modal-video-prompt').value.trim();
            if (!prompt) {
                alert('è¯·è¾“å…¥ä¸­æ–‡æç¤ºè¯ï¼');
                return;
            }
            
            const duration = document.getElementById('modal-video-duration').value;
            const aspectRatio = document.getElementById('modal-video-aspect').value;
            const sourceImage = document.getElementById('modal-source-image').src;
            
            // ä¸å…³é—­æ¨¡æ€æ¡†ï¼Œåœ¨æ¨¡æ€æ¡†å†…æ˜¾ç¤ºç”Ÿæˆè¿›åº¦
            showModalVideoProgress();
            
            // ç¦ç”¨ç”ŸæˆæŒ‰é’®ï¼Œæ˜¾ç¤ºè¿›åº¦
            const generateBtn = document.getElementById('confirm-generate-video');
            const cancelBtn = document.getElementById('cancel-video-modal');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>ç”Ÿæˆä¸­...';
            cancelBtn.textContent = 'å–æ¶ˆç”Ÿæˆ';
            
            // å¼€å§‹è§†é¢‘ç”Ÿæˆ
            await startModalVideoGeneration({
                prompt: prompt,
                frames: parseInt(duration),
                aspect_ratio: aspectRatio,
                source_image: sourceImage
            });
        }

        // ç‹¬ç«‹è§†é¢‘ç”Ÿæˆ
        async function generateVideo() {
            const prompt = document.getElementById('video-prompt').value.trim();
            const previewImg = document.getElementById('preview-img');
            
            if (!prompt) {
                alert('è¯·è¾“å…¥ä¸­æ–‡æç¤ºè¯ï¼');
                return;
            }
            
            if (!previewImg.src || previewImg.src === '') {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }
            
            const duration = document.getElementById('video-duration').value;
            const aspectRatio = document.getElementById('video-aspect').value;
            const seed = document.getElementById('video-seed').value;
            
            await startVideoGeneration({
                prompt: prompt,
                frames: parseInt(duration),
                aspect_ratio: aspectRatio,
                seed: parseInt(seed) || -1,
                source_image: previewImg.src
            });
        }

        // å¼€å§‹è§†é¢‘ç”Ÿæˆ
        async function startVideoGeneration(params) {
            const generateBtn = document.getElementById('generate-video-btn');
            const interruptBtn = document.getElementById('interrupt-btn');
            
            try {
                generateBtn.disabled = true;
                interruptBtn.disabled = false;
                
                // æ˜¾ç¤ºè§†é¢‘ç»“æœåŒºåŸŸå’Œè¿›åº¦æ¡
                const videoResultsSection = document.getElementById('video-results-section');
                const videoResults = document.getElementById('video-results');
                videoResultsSection.classList.remove('hidden');
                videoResults.innerHTML = `
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <i class="fa fa-video-camera text-blue-600 mr-3 text-lg"></i>
                            <div>
                                <p class="font-semibold text-blue-800">æ­£åœ¨ç”Ÿæˆè§†é¢‘...</p>
                                <p class="text-sm text-blue-600">é¢„è®¡éœ€è¦2-5åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…</p>
                            </div>
                        </div>
                        
                        <!-- è§†é¢‘ç”Ÿæˆè¿›åº¦æ¡ -->
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm text-gray-600">
                                <span id="video-progress-text">å‡†å¤‡æäº¤ä»»åŠ¡...</span>
                                <span id="video-progress-percentage">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div id="video-progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                            </div>
                            <div id="video-progress-steps" class="text-xs text-gray-500">
                                <div class="flex justify-between">
                                    <span class="step-item" data-step="1">ğŸ“¤ æäº¤ä»»åŠ¡</span>
                                    <span class="step-item" data-step="2">â³ æ’é˜Ÿç­‰å¾…</span>
                                    <span class="step-item" data-step="3">ğŸ¬ ç”Ÿæˆè§†é¢‘</span>
                                    <span class="step-item" data-step="4">âœ… å®Œæˆ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // åˆå§‹åŒ–è¿›åº¦æ¡
                updateVideoProgress(5, 'æ­£åœ¨æäº¤ä»»åŠ¡...', 1);
                
                const response = await fetch('/api/generate-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentVideoTaskId = result.task_id;
                    updateVideoProgress(15, 'ä»»åŠ¡å·²æäº¤ï¼Œå¼€å§‹ç”Ÿæˆ...', 2);
                    checkVideoStatus();
                } else {
                    showVideoError(result.message || 'è§†é¢‘ç”Ÿæˆå¤±è´¥');
                }
                
            } catch (error) {
                console.error('è§†é¢‘ç”Ÿæˆè¯·æ±‚å¤±è´¥:', error);
                showVideoError('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ›´æ–°è§†é¢‘ç”Ÿæˆè¿›åº¦
        function updateVideoProgress(percentage, text, step) {
            const progressBar = document.getElementById('video-progress-bar');
            const progressText = document.getElementById('video-progress-text');
            const progressPercentage = document.getElementById('video-progress-percentage');
            
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
            if (progressText) {
                progressText.textContent = text;
            }
            if (progressPercentage) {
                progressPercentage.textContent = `${percentage}%`;
            }
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            if (step) {
                const steps = document.querySelectorAll('.step-item');
                steps.forEach((stepEl, index) => {
                    if (index + 1 <= step) {
                        stepEl.style.fontWeight = 'bold';
                        stepEl.style.color = '#2563eb';
                    } else {
                        stepEl.style.fontWeight = 'normal';
                        stepEl.style.color = '#6b7280';
                    }
                });
            }
        }

        // æ£€æŸ¥è§†é¢‘ç”ŸæˆçŠ¶æ€
        async function checkVideoStatus() {
            if (!currentVideoTaskId) return;
            
            try {
                const response = await fetch('/api/check-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: currentVideoTaskId })
                });
                
                const result = await response.json();
                
                if (result.status === 'done') {
                    updateVideoProgress(100, 'è§†é¢‘ç”Ÿæˆå®Œæˆï¼', 4);
                    setTimeout(() => {
                        showVideoResult(result.video_url);
                        stopVideoChecking();
                    }, 1000);
                } else if (result.status === 'error') {
                    showVideoError(result.message || 'è§†é¢‘ç”Ÿæˆå¤±è´¥');
                    stopVideoChecking();
                } else if (result.status === 'in_queue') {
                    updateVideoProgress(25, 'ä»»åŠ¡æ’é˜Ÿä¸­ï¼Œè¯·ç¨å€™...', 2);
                    videoCheckInterval = setTimeout(checkVideoStatus, 5000);
                } else if (result.status === 'generating') {
                    // æ¨¡æ‹Ÿç”Ÿæˆè¿›åº¦
                    const currentProgress = parseInt(document.getElementById('video-progress-percentage')?.textContent) || 25;
                    const newProgress = Math.min(currentProgress + 5, 85);
                    updateVideoProgress(newProgress, 'æ­£åœ¨ç”Ÿæˆè§†é¢‘ä¸­...', 3);
                    videoCheckInterval = setTimeout(checkVideoStatus, 5000);
                } else {
                    showVideoError('è§†é¢‘ä»»åŠ¡çŠ¶æ€å¼‚å¸¸');
                    stopVideoChecking();
                }
                
            } catch (error) {
                console.error('æ£€æŸ¥è§†é¢‘çŠ¶æ€å¤±è´¥:', error);
                // ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿè¦ç»§ç»­é‡è¯•
                videoCheckInterval = setTimeout(checkVideoStatus, 5000);
            }
        }

        // åœæ­¢è§†é¢‘çŠ¶æ€æ£€æŸ¥
        function stopVideoChecking() {
            if (videoCheckInterval) {
                clearTimeout(videoCheckInterval);
                videoCheckInterval = null;
            }
            currentVideoTaskId = null;
            document.getElementById('generate-video-btn').disabled = false;
            document.getElementById('interrupt-btn').disabled = true;
        }

        // æ˜¾ç¤ºè§†é¢‘ç»“æœ
        function showVideoResult(videoUrl) {
            // å®Œæˆè¿›åº¦æ¡åŠ¨ç”»
            completeVideoProgress();
            
            // å»¶è¿Ÿ1.5ç§’åæ˜¾ç¤ºæœ€ç»ˆç»“æœ
            setTimeout(() => {
                const videoResults = document.getElementById('video-results');
                videoResults.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center">
                            <i class="fa fa-check-circle text-green-600 mr-3"></i>
                            <div>
                                <p class="font-medium text-green-800">è§†é¢‘ç”Ÿæˆå®Œæˆï¼</p>
                                <p class="text-sm text-green-600">æ‚¨çš„AIè§†é¢‘å·²æˆåŠŸåˆ›å»º</p>
                            </div>
                        </div>
                    </div>
                    <div class="relative rounded-lg overflow-hidden bg-white border border-gray-200 shadow-sm">
                        <video controls class="w-full h-auto" preload="metadata">
                            <source src="${videoUrl}" type="video/mp4">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                        </video>
                        <div class="p-4 bg-gray-50 flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <span class="text-sm text-gray-600">
                                    <i class="fa fa-video-camera mr-1"></i>AIç”Ÿæˆè§†é¢‘
                                </span>
                                <span class="text-xs text-gray-500">
                                    <i class="fa fa-clock-o mr-1"></i>åˆšåˆšç”Ÿæˆ
                                </span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="regenerateVideo()" class="btn-secondary text-sm">
                                    <i class="fa fa-refresh mr-1"></i>é‡æ–°ç”Ÿæˆ
                                </button>
                                <button onclick="downloadVideo('${videoUrl}')" class="btn-primary text-sm">
                                    <i class="fa fa-download mr-1"></i>ä¸‹è½½è§†é¢‘
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }, 1500);
        }

        // æ˜¾ç¤ºè§†é¢‘é”™è¯¯
        function showVideoError(message) {
            const videoResults = document.getElementById('video-results');
            videoResults.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fa fa-exclamation-circle text-red-600 mr-3"></i>
                        <div>
                            <p class="font-medium text-red-800">è§†é¢‘ç”Ÿæˆå¤±è´¥</p>
                            <p class="text-sm text-red-600">${message}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // è§†é¢‘è¿›åº¦æ¡ç›¸å…³å˜é‡
        let videoProgressInterval = null;
        let videoProgressValue = 0;

        // æ˜¾ç¤ºè§†é¢‘ç”Ÿæˆè¿›åº¦æ¡
        function showVideoProgressBar() {
            const videoResultsSection = document.getElementById('video-results-section');
            const videoResults = document.getElementById('video-results');
            
            videoResultsSection.classList.remove('hidden');
            videoResults.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                    <div class="flex items-center mb-4">
                        <i class="fa fa-video-camera text-blue-600 mr-3"></i>
                        <div>
                            <p class="font-medium text-blue-800">æ­£åœ¨ç”Ÿæˆè§†é¢‘...</p>
                            <p class="text-sm text-blue-600">AIæ­£åœ¨æ ¹æ®æ‚¨çš„æè¿°åˆ›ä½œè§†é¢‘ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
                        </div>
                    </div>
                    
                    <!-- è¿›åº¦æ¡ -->
                    <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                        <div id="video-progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    
                    <!-- è¿›åº¦ä¿¡æ¯ -->
                    <div class="flex justify-between items-center text-sm">
                        <span id="video-progress-text" class="text-blue-700">æ­£åœ¨åˆå§‹åŒ–...</span>
                        <span id="video-progress-percentage" class="text-blue-700 font-medium">0%</span>
                    </div>
                    
                    <!-- é¢„ä¼°æ—¶é—´ -->
                    <div class="mt-3 text-xs text-blue-600 text-center">
                        <i class="fa fa-clock-o mr-1"></i>
                        é¢„è®¡éœ€è¦ <span id="video-estimated-time">2-3</span> åˆ†é’Ÿå®Œæˆ
                    </div>
                </div>
            `;
            
            // å¯åŠ¨è¿›åº¦æ¡åŠ¨ç”»
            startVideoProgressAnimation();
        }

        // å¯åŠ¨è§†é¢‘è¿›åº¦æ¡åŠ¨ç”»
        function startVideoProgressAnimation() {
            videoProgressValue = 0;
            const progressBar = document.getElementById('video-progress-bar');
            const progressText = document.getElementById('video-progress-text');
            const progressPercentage = document.getElementById('video-progress-percentage');
            
            const stages = [
                { progress: 15, text: "æ­£åœ¨åˆ†æå›¾ç‰‡å†…å®¹...", duration: 3000 },
                { progress: 30, text: "æ­£åœ¨ç†è§£æç¤ºè¯è¯­ä¹‰...", duration: 4000 },
                { progress: 50, text: "æ­£åœ¨ç”Ÿæˆè§†é¢‘å¸§åºåˆ—...", duration: 8000 },
                { progress: 70, text: "æ­£åœ¨æ¸²æŸ“è§†é¢‘æ•ˆæœ...", duration: 6000 },
                { progress: 85, text: "æ­£åœ¨ä¼˜åŒ–è§†é¢‘è´¨é‡...", duration: 4000 },
                { progress: 95, text: "æ­£åœ¨å®Œæˆæœ€åå¤„ç†...", duration: 2000 }
            ];
            
            let currentStage = 0;
            
            function updateProgress() {
                if (currentStage < stages.length) {
                    const stage = stages[currentStage];
                    const startProgress = videoProgressValue;
                    const targetProgress = stage.progress;
                    const startTime = Date.now();
                    
                    progressText.textContent = stage.text;
                    
                    function animateToTarget() {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / stage.duration, 1);
                        
                        videoProgressValue = startProgress + (targetProgress - startProgress) * progress;
                        progressBar.style.width = `${videoProgressValue}%`;
                        progressPercentage.textContent = `${Math.round(videoProgressValue)}%`;
                        
                        if (progress < 1) {
                            videoProgressInterval = requestAnimationFrame(animateToTarget);
                        } else {
                            currentStage++;
                            setTimeout(updateProgress, 500); // çŸ­æš‚åœé¡¿åè¿›å…¥ä¸‹ä¸€é˜¶æ®µ
                        }
                    }
                    
                    animateToTarget();
                }
            }
            
            updateProgress();
        }

        // åœæ­¢è§†é¢‘è¿›åº¦æ¡åŠ¨ç”»
        function stopVideoProgressAnimation() {
            if (videoProgressInterval) {
                cancelAnimationFrame(videoProgressInterval);
                videoProgressInterval = null;
            }
        }

        // å®Œæˆè§†é¢‘è¿›åº¦æ¡
        function completeVideoProgress() {
            stopVideoProgressAnimation();
            
            const progressBar = document.getElementById('video-progress-bar');
            const progressText = document.getElementById('video-progress-text');
            const progressPercentage = document.getElementById('video-progress-percentage');
            
            if (progressBar && progressText && progressPercentage) {
                progressBar.style.width = '100%';
                progressText.textContent = 'è§†é¢‘ç”Ÿæˆå®Œæˆï¼';
                progressPercentage.textContent = '100%';
                
                // æ·»åŠ å®ŒæˆåŠ¨ç”»æ•ˆæœ
                progressBar.classList.add('animate-pulse');
                setTimeout(() => {
                    if (progressBar) {
                        progressBar.classList.remove('animate-pulse');
                    }
                }, 1000);
            }
        }

                 // é‡æ–°ç”Ÿæˆè§†é¢‘
         function regenerateVideo() {
             // è·å–å½“å‰çš„å‚æ•°ï¼ˆå¦‚æœå¯ç”¨çš„è¯ï¼‰
             const lastParams = {
                 prompt: document.getElementById('modal-video-prompt')?.value || document.getElementById('video-prompt')?.value || 'åƒå†›ä¸‡é©¬',
                 frames: 121,
                 aspect_ratio: "16:9",
                 seed: -1
             };
             
             // æ˜¾ç¤ºè¿›åº¦æ¡
             showVideoProgressBar();
             
             // é‡æ–°å¼€å§‹ç”Ÿæˆ
             startVideoGeneration(lastParams);
         }

         // ä¸‹è½½è§†é¢‘
         function downloadVideo(url) {
             try {
                 // ä½¿ç”¨fetchè·å–è§†é¢‘æ•°æ®å¹¶ä¸‹è½½
                 fetch(url)
                     .then(response => {
                         if (!response.ok) {
                             throw new Error(`HTTP error! status: ${response.status}`);
                         }
                         return response.blob();
                     })
                     .then(blob => {
                         const downloadUrl = window.URL.createObjectURL(blob);
                         const a = document.createElement('a');
                         a.style.display = 'none';
                         a.href = downloadUrl;
                         a.download = `ai_generated_video_${Date.now()}.mp4`;
                         document.body.appendChild(a);
                         a.click();
                         window.URL.revokeObjectURL(downloadUrl);
                         document.body.removeChild(a);
                         
                         // æ˜¾ç¤ºä¸‹è½½æˆåŠŸæç¤º
                         showDownloadSuccess();
                     })
                     .catch(error => {
                         console.error('ä¸‹è½½å¤±è´¥:', error);
                         // å¦‚æœä¸‹è½½å¤±è´¥ï¼Œå°è¯•ç›´æ¥æ‰“å¼€é“¾æ¥
                         const a = document.createElement('a');
                         a.href = url;
                         a.target = '_blank';
                         a.download = `ai_generated_video_${Date.now()}.mp4`;
                         document.body.appendChild(a);
                         a.click();
                         document.body.removeChild(a);
                     });
                 
             } catch (error) {
                 console.error('ä¸‹è½½å¤±è´¥:', error);
                 // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šç›´æ¥æ‰“å¼€é“¾æ¥
                 window.open(url, '_blank');
             }
         }

         // æ˜¾ç¤ºä¸‹è½½æˆåŠŸæç¤º
         function showDownloadSuccess() {
             // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æˆåŠŸæç¤º
             const toast = document.createElement('div');
             toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
             toast.innerHTML = '<i class="fa fa-check mr-2"></i>è§†é¢‘ä¸‹è½½æˆåŠŸï¼';
             document.body.appendChild(toast);
             
             // 3ç§’åè‡ªåŠ¨ç§»é™¤
             setTimeout(() => {
                                 if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 3000);
        }

        // å®Œæˆè§†é¢‘è¿›åº¦æ¡åŠ¨ç”»
        function completeVideoProgress() {
            updateVideoProgress(90, 'è§†é¢‘æ¸²æŸ“ä¸­...', 4);
            setTimeout(() => {
                updateVideoProgress(100, 'è§†é¢‘ç”Ÿæˆå®Œæˆï¼', 4);
            }, 500);
        }

        // é‡æ–°ç”Ÿæˆè§†é¢‘
        function regenerateVideo() {
            if (confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆè§†é¢‘å—ï¼Ÿè¿™å°†æ¶ˆè€—æ–°çš„ç§¯åˆ†ã€‚')) {
                // é‡æ–°è·å–æœ€åä½¿ç”¨çš„å‚æ•°
                const lastPrompt = document.getElementById('modal-video-prompt')?.value || 
                                 document.getElementById('video-prompt')?.value || '';
                const lastDuration = document.getElementById('modal-video-duration')?.value || 
                                   document.getElementById('video-duration')?.value || '121';
                const lastAspect = document.getElementById('modal-video-aspect')?.value || 
                                 document.getElementById('video-aspect')?.value || '16:9';
                
                if (lastPrompt) {
                    startVideoGeneration({
                        prompt: lastPrompt,
                        frames: parseInt(lastDuration),
                        aspect_ratio: lastAspect,
                        seed: -1  // éšæœºç§å­é‡æ–°ç”Ÿæˆ
                    });
                } else {
                    alert('æ— æ³•è·å–ç”Ÿæˆå‚æ•°ï¼Œè¯·é‡æ–°è®¾ç½®åç”Ÿæˆ');
                }
            }
        }

        // è®¡ç®—è§†é¢‘æ–‡ä»¶å¤§å°
        function calculateVideoSize(url) {
            fetch(url, { method: 'HEAD' })
                .then(response => {
                    const contentLength = response.headers.get('content-length');
                    if (contentLength) {
                        const sizeInBytes = parseInt(contentLength);
                        const sizeInMB = (sizeInBytes / 1024 / 1024).toFixed(1);
                        const sizeElement = document.getElementById('video-file-size');
                        if (sizeElement) {
                            sizeElement.textContent = `æ–‡ä»¶å¤§å°: ${sizeInMB}MB`;
                        }
                    }
                })
                .catch(error => {
                    console.log('æ— æ³•è·å–æ–‡ä»¶å¤§å°:', error);
                    const sizeElement = document.getElementById('video-file-size');
                    if (sizeElement) {
                        sizeElement.textContent = 'æ–‡ä»¶å¤§å°: æœªçŸ¥';
                    }
                });
        }

        // é‡æ–°æ’­æ”¾è§†é¢‘
        function replayVideo() {
            const video = document.querySelector('#video-results video');
            if (video) {
                video.currentTime = 0;
                video.play();
            }
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†å†…çš„è§†é¢‘ç”Ÿæˆè¿›åº¦
        function showModalVideoProgress() {
            const modalResults = document.getElementById('modal-video-results');
            const modalContent = document.getElementById('modal-video-content');
            
            modalResults.classList.remove('hidden');
            modalContent.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center mb-3">
                        <i class="fa fa-video-camera text-blue-600 mr-3"></i>
                        <div>
                            <p class="font-medium text-blue-800">æ­£åœ¨ç”Ÿæˆè§†é¢‘...</p>
                            <p class="text-sm text-blue-600">CBIT Proæ­£åœ¨æ ¹æ®æ‚¨çš„å›¾ç‰‡å’Œæè¿°åˆ›ä½œé«˜è´¨é‡è§†é¢‘</p>
                        </div>
                    </div>
                    
                    <!-- è¿›åº¦æ¡ -->
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                        <div id="modal-progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    
                    <!-- è¿›åº¦ä¿¡æ¯ -->
                    <div class="flex justify-between items-center text-sm">
                        <span id="modal-progress-text" class="text-blue-700">æ­£åœ¨åˆå§‹åŒ–...</span>
                        <span id="modal-progress-percentage" class="text-blue-700 font-medium">0%</span>
                    </div>
                    
                    <!-- é¢„ä¼°æ—¶é—´ -->
                    <div class="mt-2 text-xs text-blue-600 text-center">
                        <i class="fa fa-clock-o mr-1"></i>
                        é¢„è®¡éœ€è¦ 2-3 åˆ†é’Ÿå®Œæˆ (CBIT Proé«˜è´¨é‡ç”Ÿæˆ)
                    </div>
                </div>
            `;
        }

        // æ¨¡æ€æ¡†è§†é¢‘ç”Ÿæˆä¸»å‡½æ•°
        async function startModalVideoGeneration(params) {
            let modalCurrentTaskId = null;
            
            try {
                // åˆå§‹åŒ–è¿›åº¦
                updateModalProgress(5, 'æ­£åœ¨æäº¤ä»»åŠ¡...', 1);
                
                const response = await fetch('/api/generate-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    modalCurrentTaskId = result.task_id;
                    updateModalProgress(15, 'ä»»åŠ¡å·²æäº¤ï¼Œå¼€å§‹ç”Ÿæˆ...', 2);
                    checkModalVideoStatus(modalCurrentTaskId);
                } else {
                    showModalVideoError(result.message || 'è§†é¢‘ç”Ÿæˆå¤±è´¥');
                }
                
            } catch (error) {
                console.error('æ¨¡æ€æ¡†è§†é¢‘ç”Ÿæˆè¯·æ±‚å¤±è´¥:', error);
                showModalVideoError('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ›´æ–°æ¨¡æ€æ¡†è¿›åº¦
        function updateModalProgress(percentage, text, step) {
            const progressBar = document.getElementById('modal-progress-bar');
            const progressText = document.getElementById('modal-progress-text');
            const progressPercentage = document.getElementById('modal-progress-percentage');
            
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
            if (progressText) {
                progressText.textContent = text;
            }
            if (progressPercentage) {
                progressPercentage.textContent = `${percentage}%`;
            }
        }

        // æ£€æŸ¥æ¨¡æ€æ¡†è§†é¢‘çŠ¶æ€
        function checkModalVideoStatus(taskId) {
            const checkStatus = async () => {
                try {
                    const response = await fetch('/api/check-video', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task_id: taskId })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'done') {
                        updateModalProgress(100, 'è§†é¢‘ç”Ÿæˆå®Œæˆï¼', 4);
                        setTimeout(() => {
                            showModalVideoResult(result.video_url);
                        }, 1000);
                    } else if (result.status === 'error') {
                        showModalVideoError('è§†é¢‘ç”Ÿæˆå¤±è´¥');
                    } else if (result.status === 'in_queue') {
                        updateModalProgress(25, 'ä»»åŠ¡æ’é˜Ÿä¸­...', 2);
                        setTimeout(checkStatus, 3000);
                    } else if (result.status === 'generating') {
                        const progress = 30 + Math.random() * 40; // 30-70%çš„éšæœºè¿›åº¦
                        updateModalProgress(progress, 'æ­£åœ¨ç”Ÿæˆè§†é¢‘...', 3);
                        setTimeout(checkStatus, 3000);
                    } else {
                        setTimeout(checkStatus, 3000);
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥è§†é¢‘çŠ¶æ€å¤±è´¥:', error);
                    showModalVideoError('çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            };
            
            checkStatus();
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†è§†é¢‘ç»“æœ
        function showModalVideoResult(videoUrl) {
            const modalContent = document.getElementById('modal-video-content');
            modalContent.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                    <div class="flex items-center">
                        <i class="fa fa-check-circle text-green-600 mr-3"></i>
                        <div>
                            <p class="font-medium text-green-800">è§†é¢‘ç”Ÿæˆå®Œæˆï¼</p>
                            <p class="text-sm text-green-600">æ‚¨çš„CBIT Proé«˜è´¨é‡è§†é¢‘å·²æˆåŠŸåˆ›å»º</p>
                        </div>
                    </div>
                </div>
                <div class="relative rounded-lg overflow-hidden bg-white border border-gray-200 shadow-sm">
                    <video controls class="w-full h-auto" preload="metadata">
                        <source src="${videoUrl}" type="video/mp4">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                    </video>
                    <div class="p-3 bg-gray-50 flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-sm text-gray-600">
                                <i class="fa fa-video-camera mr-1"></i>CBIT Proç”Ÿæˆ
                            </span>
                            <span class="text-xs text-gray-500">
                                <i class="fa fa-clock-o mr-1"></i>åˆšåˆšç”Ÿæˆ
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="downloadModalVideo('${videoUrl}')" class="btn-primary text-sm">
                                <i class="fa fa-download mr-1"></i>ä¸‹è½½è§†é¢‘
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            resetModalButtons();
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†è§†é¢‘é”™è¯¯
        function showModalVideoError(message) {
            const modalContent = document.getElementById('modal-video-content');
            modalContent.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fa fa-exclamation-circle text-red-600 mr-3"></i>
                        <div>
                            <p class="font-medium text-red-800">è§†é¢‘ç”Ÿæˆå¤±è´¥</p>
                            <p class="text-sm text-red-600">${message}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            resetModalButtons();
        }

        // é‡ç½®æ¨¡æ€æ¡†æŒ‰é’®çŠ¶æ€
        function resetModalButtons() {
            const generateBtn = document.getElementById('confirm-generate-video');
            const cancelBtn = document.getElementById('cancel-video-modal');
            
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fa fa-video-camera mr-2"></i>ç”Ÿæˆè§†é¢‘ <span class="text-xs bg-yellow-500 text-black px-1 py-0.5 rounded ml-1">Pro</span>';
            cancelBtn.textContent = 'å…³é—­';
        }

        // ä¸‹è½½æ¨¡æ€æ¡†è§†é¢‘
        function downloadModalVideo(url) {
            try {
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = downloadUrl;
                        a.download = `jimeng_pro_video_${Date.now()}.mp4`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(downloadUrl);
                        document.body.removeChild(a);
                        
                        // æ˜¾ç¤ºä¸‹è½½æˆåŠŸæç¤º
                        alert('è§†é¢‘ä¸‹è½½æˆåŠŸï¼');
                    })
                    .catch(error => {
                        console.error('ä¸‹è½½å¤±è´¥:', error);
                        // å¦‚æœä¸‹è½½å¤±è´¥ï¼Œå°è¯•ç›´æ¥æ‰“å¼€é“¾æ¥
                        const a = document.createElement('a');
                        a.href = url;
                        a.target = '_blank';
                        a.download = `jimeng_pro_video_${Date.now()}.mp4`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    });
            } catch (error) {
                console.error('ä¸‹è½½è§†é¢‘å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
   </script>

    <!-- è§†é¢‘ç”Ÿæˆæ¨¡æ€æ¡† -->
    <div id="video-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">åŸºäºå›¾ç‰‡ç”Ÿæˆè§†é¢‘</h3>
                    <button id="close-video-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <!-- åŸå›¾é¢„è§ˆ -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">åŸå›¾é¢„è§ˆ</h4>
                        <img id="modal-source-image" src="" alt="åŸå›¾" class="w-full max-h-64 object-contain rounded-lg border">
                    </div>
                    
                    <!-- ä¸­æ–‡æç¤ºè¯ -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">ä¸­æ–‡æç¤ºè¯</h4>
                        <textarea id="modal-video-prompt" class="w-full bg-white border border-gray-300 rounded-lg p-3 h-24 resize-none focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="è¯·è¾“å…¥ä¸­æ–‡æè¿°ï¼Œä¾‹å¦‚ï¼šåƒå†›ä¸‡é©¬ã€æµ·æµªæ‹æ‰“å²¸è¾¹ç­‰..."></textarea>
                        <div class="mt-1 text-sm text-gray-500 flex justify-between">
                            <span>ä»…æ”¯æŒä¸­æ–‡ï¼Œå»ºè®®400å­—ä»¥å†…</span>
                            <span id="modal-char-count">0/400</span>
                        </div>
                    </div>
                    
                    <!-- å¿«é€Ÿé€‰æ‹© -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">çƒ­é—¨æ•ˆæœ</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="modal-preset-btn text-xs px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded transition-colors text-left" data-prompt="åƒå†›ä¸‡é©¬å¥”è…¾åœ¨å¹¿é˜”çš„è‰åŸä¸Šï¼Œå°˜åœŸé£æ‰¬ï¼Œæ°”åŠ¿æ¢å®">åƒå†›ä¸‡é©¬</button>
                            <button class="modal-preset-btn text-xs px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded transition-colors text-left" data-prompt="æµ·æµªæ‹æ‰“åœ¨ç¤çŸ³ä¸Šï¼Œæ°´èŠ±å››æº…ï¼Œé˜³å…‰ç…§å°„ä¸‹æ³¢å…‰ç²¼ç²¼">æµ·æµªæ‹å²¸</button>
                            <button class="modal-preset-btn text-xs px-3 py-2 bg-green-50 hover:bg-green-100 rounded transition-colors text-left" data-prompt="æ¨±èŠ±èŠ±ç“£åœ¨æ˜¥é£ä¸­é£˜è½ï¼Œç²‰è‰²èŠ±ç“£æ»¡å¤©é£èˆï¼Œå”¯ç¾æµªæ¼«">æ¨±èŠ±é£˜è½</button>
                            <button class="modal-preset-btn text-xs px-3 py-2 bg-green-50 hover:bg-green-100 rounded transition-colors text-left" data-prompt="åŸå¸‚å¤œæ™¯ä¸­éœ“è™¹ç¯é—ªçƒï¼Œè½¦æµå¦‚æ²³ï¼Œç¯ç«è¾‰ç…Œ">éƒ½å¸‚å¤œæ™¯</button>
                        </div>
                    </div>
                    
                    <!-- è§†é¢‘å‚æ•° -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è§†é¢‘æ—¶é•¿</label>
                            <select id="modal-video-duration" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="121">5ç§’ (121å¸§)</option>
                                <option value="241">10ç§’ (241å¸§)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å®½é«˜æ¯”</label>
                            <select id="modal-video-aspect" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="16:9">16:9 (æ¨ªå±)</option>
                                <option value="9:16">9:16 (ç«–å±)</option>
                                <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                                <option value="4:3">4:3 (æ ‡å‡†)</option>
                                <option value="3:4">3:4 (ç«–ç‰ˆæ ‡å‡†)</option>
                                <option value="21:9">21:9 (è¶…å®½å±)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- è§†é¢‘ç”Ÿæˆç»“æœåŒºåŸŸ -->
                    <div id="modal-video-results" class="hidden mt-4">
                        <div class="border-t border-gray-200 pt-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                                <i class="fa fa-video-camera text-primary mr-2"></i>è§†é¢‘ç”Ÿæˆç»“æœ
                            </h4>
                            <div id="modal-video-content"></div>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex space-x-3 pt-4">
                        <button id="cancel-video-modal" class="flex-1 btn-secondary">å–æ¶ˆ</button>
                        <button id="confirm-generate-video" class="flex-1 btn-primary">
                            <i class="fa fa-video-camera mr-2"></i>ç”Ÿæˆè§†é¢‘ <span class="text-xs bg-yellow-500 text-black px-1 py-0.5 rounded ml-1">Pro</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è§†é¢‘ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
    <div id="video-results-section" class="hidden mt-6">
        <div class="glass-effect rounded-xl p-5">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-video-camera text-primary mr-2"></i> è§†é¢‘ç”Ÿæˆç»“æœ
            </h3>
            <div id="video-results"></div>
        </div>
    </div>
</body>
</html> 