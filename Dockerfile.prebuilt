FROM python:3.12-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV HOST=0.0.0.0
ENV PORT=5000
ENV DEBUG=False

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc g++ curl sqlite3 \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶requirementså¹¶å®‰è£…Pythonä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /app/db /app/downloads /app/static/uploads

# å¤åˆ¶é¢„ç½®æ•°æ®åº“åˆ°å®¹å™¨å†…
COPY db/prebuilt_cache.db /app/db/prebuilt_cache.db

# è®¾ç½®æ•°æ®åº“æ–‡ä»¶æƒé™
RUN chmod 666 /app/db/prebuilt_cache.db && \
    chmod 777 /app/db /app/downloads /app/static/uploads

# è®¾ç½®æ•°æ®åº“ç¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨é¢„ç½®æ•°æ®åº“ï¼‰
ENV SQLALCHEMY_DATABASE_URI=sqlite:///db/runtime_cache.db

# æš´éœ²ç«¯å£
EXPOSE 5000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:5000/health || exit 1

# åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼Œç¡®ä¿æ•°æ®åº“è®¾ç½®æ­£ç¡®
RUN echo '#!/bin/bash\n\
echo "ğŸš€ å¯åŠ¨CBIT-AiStudio (é¢„ç½®æ•°æ®åº“ç‰ˆ)..."\n\
echo "ğŸ”§ æ£€æŸ¥é¢„ç½®æ•°æ®åº“..."\n\
if [ -f /app/db/prebuilt_cache.db ]; then\n\
    echo "âœ… é¢„ç½®æ•°æ®åº“å­˜åœ¨: /app/db/prebuilt_cache.db"\n\
    ls -la /app/db/prebuilt_cache.db\n\
else\n\
    echo "âŒ é¢„ç½®æ•°æ®åº“ä¸å­˜åœ¨"\n\
    exit 1\n\
fi\n\
echo "ğŸ”§ ç¡®ä¿ç›®å½•æƒé™..."\n\
chmod 777 /app/db /app/downloads /app/static/uploads\n\
chmod 666 /app/db/prebuilt_cache.db\n\
echo "âœ… æƒé™è®¾ç½®å®Œæˆ"\n\
echo "ğŸš€ å¯åŠ¨åº”ç”¨..."\n\
exec python app_prebuilt_db.py' > /app/start_prebuilt.sh && chmod +x /app/start_prebuilt.sh

# ä½¿ç”¨é¢„ç½®æ•°æ®åº“å¯åŠ¨è„šæœ¬
CMD ["/app/start_prebuilt.sh"]
