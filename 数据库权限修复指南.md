# 🔧 CBIT-AiStudio 数据库权限修复指南

## 📋 问题描述

如果你遇到以下错误：
```
sqlite3.OperationalError: unable to open database file
```

这是SQLite数据库权限问题，通常发生在Docker容器环境中。

## 🚀 快速修复方案

### 方案一：自动修复脚本（推荐）

在服务器上运行专项修复脚本：

```bash
# 在项目根目录执行
sudo ./fix_database_permissions.sh
```

**修复内容**：
- ✅ 自动备份现有数据库
- ✅ 安全停止当前项目容器（不影响其他容器）
- ✅ 修复instance目录权限 (777)
- ✅ 修复数据库文件权限 (666)
- ✅ 测试数据库连接
- ✅ 创建安全启动脚本
- ✅ 重新启动应用

### 方案二：手动修复

如果自动脚本无法运行，可以手动执行：

```bash
# 1. 停止容器
docker stop cbit-aistudio
docker rm cbit-aistudio

# 2. 修复权限
chmod 777 instance
chmod 777 downloads
chmod 777 static/uploads

# 3. 修复数据库文件权限（如果存在）
chmod 666 instance/local_cache.db

# 4. 重新启动
docker-compose up -d
```

## 🧪 测试验证

### 本地测试
```bash
# 测试数据库连接
python3 test_local_db.py
```

### 容器测试
```bash
# 检查容器状态
docker ps | grep cbit-aistudio

# 检查应用健康
curl http://localhost:5000/health

# 查看容器日志
docker logs cbit-aistudio
```

## 🔒 安全保证

### 隔离性保证
- ✅ **只影响CBIT-AiStudio项目**：脚本通过项目名称和目录严格限制作用范围
- ✅ **不影响其他宝塔容器**：只操作当前项目的容器和文件
- ✅ **安全的权限设置**：使用最小必要权限原则
- ✅ **自动备份**：修复前自动备份数据库文件

### 权限说明
```bash
# 目录权限 777 (rwxrwxrwx)
# - 允许Docker容器用户访问
# - 允许宿主机用户管理
# - 仅限于项目目录内

# 数据库文件权限 666 (rw-rw-rw-)
# - 允许读写访问
# - 不允许执行（安全）
# - 容器和宿主机都可访问
```

## 📊 故障排除

### 常见问题

**Q1: 修复后仍然报错？**
```bash
# 检查容器日志
docker logs cbit-aistudio

# 重新运行修复脚本
sudo ./fix_database_permissions.sh
```

**Q2: 权限修复失败？**
```bash
# 检查当前用户权限
whoami
ls -la instance/

# 使用sudo运行
sudo ./fix_database_permissions.sh
```

**Q3: 容器无法启动？**
```bash
# 检查Docker服务
systemctl status docker

# 检查端口占用
netstat -tlnp | grep :5000

# 强制重新构建
docker-compose build --no-cache
docker-compose up -d
```

### 日志分析

**正常启动日志**：
```
cbit-aistudio | 🚀 启动BaiduCBIT本地版本 v2.0...
cbit-aistudio | ✓ 本地数据库已初始化
cbit-aistudio | ✅ 服务器连接正常
```

**权限错误日志**：
```
cbit-aistudio | sqlite3.OperationalError: unable to open database file
```

## 🔄 维护建议

### 定期维护
```bash
# 每周检查一次数据库状态
python3 test_local_db.py

# 每月备份数据库
cp instance/local_cache.db instance/backup_$(date +%Y%m%d).db
```

### 更新部署
```bash
# 拉取最新代码
git pull origin main

# 使用安全启动脚本
./safe_start.sh
```

## 📞 技术支持

如果问题仍然存在：

1. **查看详细日志**：`docker logs cbit-aistudio -f`
2. **检查系统资源**：`df -h` 和 `free -m`
3. **重启Docker服务**：`sudo systemctl restart docker`
4. **联系技术支持**：提供错误日志和系统信息

## 🎯 预防措施

### 部署最佳实践
1. **使用专用用户**：为Docker创建专用用户
2. **定期备份**：设置自动备份计划
3. **监控日志**：配置日志监控和告警
4. **权限审计**：定期检查文件权限

### 宝塔面板配置
1. **Docker管理**：使用宝塔Docker管理器
2. **文件管理**：通过宝塔文件管理器检查权限
3. **进程监控**：配置进程监控和自动重启
4. **安全设置**：配置防火墙和访问控制

---

**✨ 修复完成后，你的CBIT-AiStudio应用将正常运行，不会影响其他宝塔容器！**
