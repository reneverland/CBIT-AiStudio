# 🚀 CBIT-AiStudio 预置数据库解决方案指南

## 📋 方案概述

这是一个**彻底解决数据库权限问题**的方案，通过将SQLite数据库文件直接打包到Docker镜像中，完全避免宿主机权限问题。

### 🎯 解决的问题
- ✅ `sqlite3.OperationalError: unable to open database file`
- ✅ Docker容器数据库权限问题
- ✅ 宿主机与容器用户权限冲突
- ✅ 数据库文件访问权限问题

### 💡 方案原理
1. **预置数据库**：在构建时创建数据库文件
2. **打包到镜像**：将数据库文件包含在Docker镜像中
3. **容器内复制**：启动时复制到运行时位置
4. **无外部依赖**：完全不依赖宿主机文件系统权限

## 🚀 快速部署

### 一键部署
```bash
# 在项目根目录执行
./deploy_prebuilt_db.sh
```

### 手动部署步骤

1. **创建预置数据库**
   ```bash
   python3 create_prebuilt_db.py
   ```

2. **构建预置数据库版本**
   ```bash
   docker-compose -f docker-compose.prebuilt.yml build --no-cache
   ```

3. **启动服务**
   ```bash
   docker-compose -f docker-compose.prebuilt.yml up -d
   ```

## 📁 文件结构

```
CBIT-AiStudio/
├── db/                                    # 预置数据库目录
│   └── prebuilt_cache.db                 # 预置数据库文件
├── app_prebuilt_db.py                    # 预置数据库版本应用
├── create_prebuilt_db.py                 # 数据库创建脚本
├── Dockerfile.prebuilt                   # 预置数据库Dockerfile
├── docker-compose.prebuilt.yml          # 预置数据库compose文件
├── deploy_prebuilt_db.sh                 # 一键部署脚本
├── manage_prebuilt.sh                    # 管理脚本
└── 预置数据库解决方案指南.md             # 本文档
```

## 🛠️ 管理命令

使用 `manage_prebuilt.sh` 脚本管理服务：

```bash
# 启动服务
./manage_prebuilt.sh start

# 停止服务
./manage_prebuilt.sh stop

# 重启服务
./manage_prebuilt.sh restart

# 重建镜像
./manage_prebuilt.sh rebuild

# 查看日志
./manage_prebuilt.sh logs

# 检查状态
./manage_prebuilt.sh status

# 健康检查
./manage_prebuilt.sh health

# 数据库信息
./manage_prebuilt.sh db-info

# 进入容器
./manage_prebuilt.sh shell
```

## 🔍 验证部署

### 1. 检查容器状态
```bash
docker ps | grep cbit-aistudio-prebuilt
```

### 2. 健康检查
```bash
curl http://localhost:5000/health
```

**期望输出**：
```json
{
  "status": "ok",
  "local": true,
  "server": true,
  "database": true,
  "database_status": "connected",
  "database_uri": "sqlite:///db/runtime_cache.db",
  "prebuilt_db": true,
  "timestamp": "2025-10-03T..."
}
```

### 3. 检查数据库
```bash
./manage_prebuilt.sh db-info
```

## 🔧 技术细节

### 数据库流程
1. **构建时**：`create_prebuilt_db.py` 创建 `db/prebuilt_cache.db`
2. **镜像打包**：Dockerfile 将数据库文件复制到 `/app/db/prebuilt_cache.db`
3. **运行时**：应用启动时复制到 `/app/db/runtime_cache.db`
4. **使用**：应用连接到运行时数据库文件

### 权限设置
```dockerfile
# 在Dockerfile中设置
RUN chmod 666 /app/db/prebuilt_cache.db && \
    chmod 777 /app/db
```

### 启动脚本
```bash
# 容器启动时执行
if [ -f /app/db/prebuilt_cache.db ]; then
    echo "✅ 预置数据库存在"
    # 复制到运行时位置
    cp /app/db/prebuilt_cache.db /app/db/runtime_cache.db
    chmod 666 /app/db/runtime_cache.db
fi
```

## 🆚 与其他方案对比

| 特性 | 预置数据库方案 | 权限修复方案 | 紧急修复方案 |
|------|---------------|-------------|-------------|
| **解决彻底性** | 🟢 完全解决 | 🟡 大部分解决 | 🟡 强力解决 |
| **部署复杂度** | 🟢 简单 | 🟡 中等 | 🔴 复杂 |
| **数据持久化** | 🔴 不持久化 | 🟢 完全持久化 | 🟢 完全持久化 |
| **权限依赖** | 🟢 无依赖 | 🔴 依赖宿主机 | 🔴 依赖宿主机 |
| **适用场景** | 🟢 开发/测试 | 🟢 生产环境 | 🟢 紧急修复 |

## 💾 数据管理

### 数据不持久化说明
- ⚠️ **重要**：此方案中数据库在容器内，容器删除后数据丢失
- 🎯 **适用场景**：开发、测试、演示环境
- 💡 **生产环境**：建议使用权限修复方案或外部数据库

### 数据导出（如需要）
```bash
# 进入容器
./manage_prebuilt.sh shell

# 在容器内导出数据
sqlite3 /app/db/runtime_cache.db .dump > /app/downloads/backup.sql

# 从宿主机复制
docker cp cbit-aistudio-prebuilt:/app/downloads/backup.sql ./backup.sql
```

### 数据导入（如需要）
```bash
# 复制SQL文件到容器
docker cp backup.sql cbit-aistudio-prebuilt:/app/downloads/

# 进入容器导入
./manage_prebuilt.sh shell
sqlite3 /app/db/runtime_cache.db < /app/downloads/backup.sql
```

## 🔄 切换到其他方案

### 切换到权限修复方案
```bash
# 停止预置数据库版本
./manage_prebuilt.sh stop

# 启动权限修复版本
./fix_database_permissions.sh
```

### 切换到紧急修复方案
```bash
# 停止预置数据库版本
./manage_prebuilt.sh stop

# 运行紧急修复
./emergency_force_fix.sh
```

## 🚨 故障排除

### 常见问题

**Q1: 容器启动失败？**
```bash
# 查看详细日志
./manage_prebuilt.sh logs

# 检查预置数据库
ls -la db/prebuilt_cache.db
```

**Q2: 健康检查失败？**
```bash
# 检查容器内数据库
./manage_prebuilt.sh db-info

# 进入容器调试
./manage_prebuilt.sh shell
```

**Q3: 数据库文件不存在？**
```bash
# 重新创建预置数据库
python3 create_prebuilt_db.py

# 重建镜像
./manage_prebuilt.sh rebuild
```

## 🎯 最佳实践

### 开发环境
- ✅ 使用预置数据库方案
- ✅ 快速启动，无权限问题
- ✅ 数据重置简单

### 测试环境
- ✅ 使用预置数据库方案
- ✅ 环境一致性好
- ✅ 部署简单

### 生产环境
- ⚠️ 考虑数据持久化需求
- 💡 如需持久化，使用权限修复方案
- 💡 如不需持久化，可使用预置数据库方案

## 📞 技术支持

如果遇到问题：

1. **查看日志**：`./manage_prebuilt.sh logs`
2. **检查状态**：`./manage_prebuilt.sh status`
3. **健康检查**：`./manage_prebuilt.sh health`
4. **重建服务**：`./manage_prebuilt.sh rebuild`

---

**🎉 预置数据库方案彻底解决了权限问题，让你的应用稳定运行！**
